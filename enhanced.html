<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI çŸ¥è¯†åº“åŠ©æ‰‹ - å¢å¼ºç‰ˆ</title>
    <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            /* åŠ è½½åŠ¨ç”» */
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .loading-spinner {
                display: inline-block;
                animation: spin 1s linear infinite;
            }
            
            /* é€šçŸ¥å¼¹çª—æ ·å¼ */
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transform: translateX(400px);
                transition: transform 0.3s ease-in-out;
            }
            
            .notification.show {
                transform: translateX(0);
            }
            
            .notification.success {
                background-color: #27ae60;
            }
            
            .notification.error {
                background-color: #e74c3c;
            }
            
            .notification.warning {
                background-color: #f39c12;
            }
            
            .notification .close-btn {
                float: right;
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                margin-left: 10px;
            }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: #1e1e1e;
            color: #cccccc;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 40px;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
        }
        
        .sidebar-title {
            font-weight: bold;
            font-size: 14px;
            color: #cccccc;
        }
        
        .collapse-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #cccccc;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        
        .collapse-btn:hover {
            background-color: #3e3e42;
        }
        
        .sidebar.collapsed .sidebar-title,
        .sidebar.collapsed .toolbar,
        .sidebar.collapsed .file-tree {
            display: none;
        }
        
        .sidebar.collapsed .sidebar-header {
            justify-content: center;
        }
        
        .file-tree {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .editor-container {
            flex: 1;
            display: flex;
        }
        
        .monaco-editor-wrapper {
            flex: 1;
            position: relative;
        }
        
        .preview {
            flex: 1;
            padding: 20px;
            background-color: #1e1e1e;
            border-left: 1px solid #3e3e42;
            overflow-y: auto;
            display: none;
            color: #cccccc;
        }
        
        .preview h1, .preview h2, .preview h3 {
            color: #ffffff;
            margin: 16px 0 8px 0;
        }
        
        .preview h1 { font-size: 2em; border-bottom: 1px solid #3e3e42; padding-bottom: 8px; }
        .preview h2 { font-size: 1.5em; }
        .preview h3 { font-size: 1.2em; }
        
        .preview p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .preview code {
            background-color: #2d2d30;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .preview pre {
            background-color: #2d2d30;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }
        
        .preview blockquote {
            border-left: 4px solid #007acc;
            padding-left: 12px;
            margin: 8px 0;
            color: #a0a0a0;
        }
        
        .ai-panel {
            width: 350px;
            background-color: #252526;
            border-left: 1px solid #3e3e42;
            padding: 20px;
        }
        
        .file-item {
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            margin-bottom: 1px;
            transition: background-color 0.2s;
            color: #cccccc;
            display: flex;
            align-items: center;
            user-select: none;
        }
        
        .file-item:hover {
            background-color: #2a2d2e;
        }
        
        .file-item.selected {
            background-color: #094771;
            color: white;
        }
        
        .file-item.directory {
            font-weight: bold;
        }
        
        .file-item.markdown {
            color: #4fc3f7;
        }
        
        .file-item.selected.markdown {
            color: white;
        }
        
        .tree-indent {
            width: 16px;
            height: 16px;
            display: inline-block;
        }
        
        .expand-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 4px;
            font-size: 10px;
            transition: transform 0.2s ease;
            cursor: pointer;
            transform-origin: center;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        .file-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .file-children {
            margin-left: 16px;
            display: none;
        }
        
        .file-children.expanded {
            display: block;
        }
        
        .file-item.directory {
            display: flex;
            align-items: center;
        }
        
        .file-item.directory > span:last-child {
            cursor: pointer;
        }
        
        .toolbar {
            height: 40px;
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }
        
        .btn {
            padding: 0 10px;
            margin-right: 8px;
            border: 1px solid #464647;
            background-color: #3c3c3c;
            color: #cccccc;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #464647;
        }
        
        .btn.active {
            background-color: #007acc;
            color: white;
            border-color: #007acc;
        }
        
        .status-bar {
            height: 25px;
            background-color: #007acc;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
        }
        
        .welcome-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #a0a0a0;
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }
        
        .path-input {
            flex: 1;
            padding: 5px 8px;
            margin-right: 8px;
            border: 1px solid #464647;
            border-radius: 3px;
            background-color: #3c3c3c;
            color: #cccccc;
            height: 28px;
            box-sizing: border-box;
        }
        
        .path-input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .file-meta {
            font-size: 11px;
            color: #808080;
            margin-top: 2px;
        }
        
        .loading {
            color: #a0a0a0;
            font-style: italic;
        }
        
        .error {
            color: #f48771;
            background-color: #5a1d1d;
            padding: 10px;
            border-radius: 4px;
            margin: 10px;
            border: 1px solid #be1100;
        }
        
        .ai-output {
            margin-top: 20px;
            padding: 15px;
            background-color: #1e1e1e;
            border-radius: 4px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #3e3e42;
            color: #cccccc;
        }
        
        .ai-output h4 {
            color: #ffffff;
            margin-bottom: 10px;
        }
        
        .feature-preview {
            background-color: #2d2d30;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #007acc;
        }
        
        .feature-preview strong {
            color: #ffffff;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .stat-item {
            background-color: #2d2d30;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .stat-label {
            font-size: 11px;
            color: #a0a0a0;
        }
        
        /* è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
        .settings-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .settings-content {
            background-color: #2d2d30;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            color: #cccccc;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #cccccc;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .close-btn:hover {
            background-color: #464647;
        }
        
        /* é€‰é¡¹å¡æ ·å¼ */
        .settings-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            color: #cccccc;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            color: #ffffff;
            background-color: #464647;
        }
        
        .tab-btn.active {
            color: #007acc;
            border-bottom-color: #007acc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* å¤‡ä»½ç®¡ç†æ ·å¼ */
        .backup-section h3 {
            color: #ffffff;
            margin-bottom: 10px;
        }
        
        .backup-info {
            color: #cccccc;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .backup-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .backup-list h4 {
            color: #ffffff;
            margin-bottom: 15px;
        }
        
        .backup-item {
            background-color: #3e3e42;
            border: 1px solid #464647;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .backup-info-text {
            color: #cccccc;
        }
        
        .backup-time {
            color: #888888;
            font-size: 12px;
        }
        
        .backup-actions-btn {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Promptæ¨¡æ¿æ ·å¼ */
        .prompt-section h3 {
            color: #ffffff;
            margin-bottom: 10px;
        }
        
        .prompt-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .prompt-list h4 {
            color: #ffffff;
            margin-bottom: 15px;
        }
        
        .prompt-item {
            background-color: #3e3e42;
            border: 1px solid #464647;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .prompt-title {
            color: #ffffff;
            font-weight: bold;
            margin: 0;
        }
        
        .prompt-category {
            background-color: #007acc;
            color: #ffffff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .prompt-description {
            color: #cccccc;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .prompt-content-preview {
            background-color: #2d2d30;
            border: 1px solid #464647;
            border-radius: 4px;
            padding: 10px;
            color: #cccccc;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .prompt-actions-btn {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid #3e3e42;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #464647;
            border-radius: 4px;
            background-color: #3c3c3c;
            color: #cccccc;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .form-input[type="password"] {
            font-family: monospace;
        }
        
        .form-help {
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 4px;
        }
        
        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #3e3e42;
        }
        
        .btn-primary {
            background-color: #007acc;
            color: white;
            border: 1px solid #007acc;
        }
        
        .btn-primary:hover {
            background-color: #005a9e;
        }
        
        .btn-secondary {
            background-color: #464647;
            color: #cccccc;
            border: 1px solid #464647;
        }
        
        .btn-secondary:hover {
            background-color: #5a5a5a;
        }
        
        /* å³ä¾§é¢æ¿Tabæ ·å¼ */
        .panel-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .panel-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            color: #cccccc;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .panel-tab:hover {
            color: #ffffff;
            background-color: #3e3e42;
        }
        
        .panel-tab.active {
            color: #007acc;
            border-bottom-color: #007acc;
        }
        
        .panel-content {
            display: none;
        }
        
        .panel-content.active {
            display: block;
        }
        
        /* ç•ªèŒ„é’Ÿæ ·å¼ */
        .timer-display {
            text-align: center;
            margin: 30px 0;
        }
        
        .timer-time {
            font-size: 48px;
            font-weight: bold;
            color: #4fc3f7;
            font-family: 'Monaco', 'Consolas', monospace;
            margin-bottom: 10px;
        }
        
        .timer-status {
            font-size: 16px;
            color: #cccccc;
            margin-bottom: 20px;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .timer-settings {
            background-color: #2d2d30;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .timer-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .timer-preset {
            background-color: #3e3e42;
            border: 1px solid #464647;
            color: #cccccc;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .timer-preset:hover {
            background-color: #464647;
        }
        
        .timer-preset.active {
            background-color: #007acc;
            color: white;
        }
        
        .custom-time {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-input {
            width: 60px;
            padding: 5px;
            border: 1px solid #464647;
            border-radius: 3px;
            background-color: #3c3c3c;
            color: #cccccc;
            text-align: center;
        }
        
        .timer-stats {
            background-color: #2d2d30;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #a0a0a0;
        }
        
        .stat-value {
            color: #4fc3f7;
            font-weight: bold;
        }
        
        /* Floating Dock æ ·å¼ */
        .floating-dock-container {
            display: flex;
            justify-content: center;
            margin: 10px 0;
            perspective: 1000px;
        }
        
        .floating-dock {
            display: flex;
            gap: 10px;
            background: rgba(46, 46, 46, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .dock-item {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 15px;
        }
        
        .dock-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }
        
        .dock-item:active {
            transform: scale(0.95) translateY(-2px);
        }
        
        .dock-icon {
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .dock-item:hover .dock-icon {
            transform: scale(1.2);
        }
        
        .dock-tooltip {
            position: absolute;
            top: -30px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .dock-item:hover .dock-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* æ·»åŠ åŠ¨ç”»æ•ˆæœ */
        @keyframes dock-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .floating-dock:hover {
            transform: scale(1.05);
        }
        
        .floating-dock:hover .dock-item:not(:hover) {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <!-- ä¾§è¾¹æ  - æ–‡ä»¶æ ‘ -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">æ–‡ä»¶æµè§ˆå™¨</span>
                    <button class="collapse-btn" onclick="toggleSidebar()" title="æŠ˜å /å±•å¼€ä¾§è¾¹æ ">â—€</button>
                </div>
                <div class="toolbar">
                    <input type="text" class="path-input" id="pathInput" placeholder="è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„...">
                    <button class="btn" onclick="loadPath()">ğŸ“ åŠ è½½</button>
                    <button class="btn" onclick="refreshFileTree()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div class="file-tree" id="fileTree">
                    <div class="welcome-message">
                        ğŸ—‚ï¸ è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„<br>
                        ä¾‹å¦‚: C:\\Users\\YourName\\Documents
                    </div>
                </div>
            </div>
            
            <!-- ä¸»å†…å®¹åŒº - ç¼–è¾‘å™¨ -->
            <div class="main-content">
                <div class="toolbar">
                    <button class="btn" onclick="saveFile()" title="ä¿å­˜ (Ctrl+S)">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn" id="previewBtn" onclick="togglePreview()" title="é¢„è§ˆ (Ctrl+P)">ğŸ‘ï¸ é¢„è§ˆ</button>
                    <button class="btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“ ä¸»é¢˜</button>
                    <button class="btn" onclick="formatDocument()" title="æ ¼å¼åŒ–æ–‡æ¡£ (Alt+Shift+F)">âœ¨ æ ¼å¼åŒ–</button>
                    <span id="currentFile" style="margin-left: 10px; color: #a0a0a0;">æœªé€‰æ‹©æ–‡ä»¶</span>
                </div>
                <div class="editor-container">
                    <div class="monaco-editor-wrapper" id="monacoContainer"></div>
                    <div class="preview" id="preview"></div>
                </div>
            </div>
            
            <!-- AIé¢æ¿ -->
            <div class="ai-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>ğŸ”§ å·¥å…·é¢æ¿</h3>
                    <button class="btn" onclick="openSettings()" title="è®¾ç½®">âš™ï¸</button>
                </div>
                
                <!-- Tabå¯¼èˆª -->
                <div class="panel-tabs">
                    <button class="panel-tab active" onclick="switchPanelTab('ai')">ğŸ¤– AIåŠ©æ‰‹</button>
                    <button class="panel-tab" onclick="switchPanelTab('timer')">ğŸ… ç•ªèŒ„é’Ÿ</button>
                </div>
                
                <!-- AIåŠ©æ‰‹Tabå†…å®¹ -->
                <div id="aiPanel" class="panel-content active">
                    <!-- Promptæ¨¡æ¿å¿«é€Ÿé€‰æ‹© -->
                    <div style="margin-bottom: 15px;">
                        <label style="color: #ffffff; font-size: 14px; margin-bottom: 8px; display: block;">ğŸ¯ å¿«é€Ÿæ¨¡æ¿</label>
                        <select id="quickPromptSelect" class="form-input" style="margin-bottom: 8px;" onchange="applyQuickPrompt()">
                            <option value="">é€‰æ‹©Promptæ¨¡æ¿...</option>
                        </select>
                    </div>
                    
                    <!-- AIè¾“å…¥æ¡† -->
                    <div style="margin-bottom: 15px;">
                        <label style="color: #ffffff; font-size: 14px; margin-bottom: 8px; display: block;">ğŸ’¬ AIå¯¹è¯</label>
                        <textarea id="aiInput" class="form-input" rows="4" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–ä½¿ç”¨ä¸Šæ–¹çš„Promptæ¨¡æ¿..."></textarea>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 8px;" onclick="sendToAI()">ğŸš€ å‘é€</button>
                    </div>
                    
                    <!-- é¢„è®¾åŠŸèƒ½æŒ‰é’® - Floating Dock UI -->
                    <div style="border-top: 1px solid #3e3e42; padding-top: 15px; margin-bottom: 15px;">
                        <label style="color: #ffffff; font-size: 14px; margin-bottom: 8px; display: block;">âš¡ å¿«é€ŸåŠŸèƒ½</label>
                        <div class="floating-dock-container">
                            <div class="floating-dock">
                                <button class="dock-item" onclick="generateDailyPlan()" title="ç”Ÿæˆæ¯æ—¥è§„åˆ’">
                                    <div class="dock-icon">ğŸ“…</div>
                                    <div class="dock-tooltip">ç”Ÿæˆæ¯æ—¥è§„åˆ’</div>
                                </button>
                                <button class="dock-item" onclick="integrateThoughts()" title="æ•´åˆæ€æƒ³ç¢ç‰‡">
                                    <div class="dock-icon">ğŸ’¡</div>
                                    <div class="dock-tooltip">æ•´åˆæ€æƒ³ç¢ç‰‡</div>
                                </button>
                                <button class="dock-item" onclick="analyzeContent()" title="å†…å®¹åˆ†æ">
                                    <div class="dock-icon">ğŸ“Š</div>
                                    <div class="dock-tooltip">å†…å®¹åˆ†æ</div>
                                </button>
                                <button class="dock-item" onclick="generateSummary()" title="ç”Ÿæˆæ‘˜è¦">
                                    <div class="dock-icon">ğŸ“</div>
                                    <div class="dock-tooltip">ç”Ÿæˆæ‘˜è¦</div>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="aiOutput" class="ai-output">
                        <p style="color: #a0a0a0; text-align: center; margin-top: 50px;">ğŸ¤– AIåŠ©æ‰‹å·²å°±ç»ª<br><br>é€‰æ‹©æ¨¡æ¿æˆ–è¾“å…¥é—®é¢˜å¼€å§‹å¯¹è¯</p>
                    </div>
                </div>
                
                <!-- ç•ªèŒ„é’ŸTabå†…å®¹ -->
                <div id="timerPanel" class="panel-content">
                    <!-- è®¡æ—¶å™¨æ˜¾ç¤º -->
                    <div class="timer-display">
                        <div class="timer-time" id="timerDisplay">25:00</div>
                        <div class="timer-status" id="timerStatus">å‡†å¤‡å¼€å§‹å·¥ä½œ</div>
                    </div>
                    
                    <!-- æ§åˆ¶æŒ‰é’® -->
                    <div class="timer-controls">
                        <button class="btn btn-primary" id="startBtn" onclick="startTimer()">â–¶ï¸ å¼€å§‹</button>
                        <button class="btn btn-secondary" id="pauseBtn" onclick="pauseTimer()" style="display: none;">â¸ï¸ æš‚åœ</button>
                        <button class="btn btn-secondary" onclick="resetTimer()">ğŸ”„ é‡ç½®</button>
                    </div>
                    
                    <!-- æ—¶é—´è®¾ç½® -->
                    <div class="timer-settings">
                        <h4 style="color: #ffffff; margin-bottom: 10px;">â° æ—¶é—´è®¾ç½®</h4>
                        
                        <!-- é¢„è®¾æ—¶é—´ -->
                        <div class="timer-presets">
                            <button class="timer-preset active" onclick="setPresetTime(25)">25åˆ†é’Ÿ</button>
                            <button class="timer-preset" onclick="setPresetTime(15)">15åˆ†é’Ÿ</button>
                            <button class="timer-preset" onclick="setPresetTime(30)">30åˆ†é’Ÿ</button>
                            <button class="timer-preset" onclick="setPresetTime(45)">45åˆ†é’Ÿ</button>
                            <button class="timer-preset" onclick="setPresetTime(5)">ä¼‘æ¯5åˆ†</button>
                        </div>
                        
                        <!-- è‡ªå®šä¹‰æ—¶é—´ -->
                        <div class="custom-time">
                            <span style="color: #cccccc;">è‡ªå®šä¹‰:</span>
                            <input type="number" id="customMinutes" class="time-input" min="1" max="120" value="25">
                            <span style="color: #cccccc;">åˆ†é’Ÿ</span>
                            <button class="btn btn-small" onclick="setCustomTime()">è®¾ç½®</button>
                        </div>
                    </div>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="timer-stats">
                        <h4 style="color: #ffffff; margin-bottom: 10px;">ğŸ“Š ä»Šæ—¥ç»Ÿè®¡</h4>
                        <div class="stat-row">
                            <span class="stat-label">å®Œæˆç•ªèŒ„é’Ÿ:</span>
                            <span class="stat-value" id="completedPomodoros">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ä¸“æ³¨æ—¶é—´:</span>
                            <span class="stat-value" id="focusTime">0åˆ†é’Ÿ</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ä¼‘æ¯æ—¶é—´:</span>
                            <span class="stat-value" id="breakTime">0åˆ†é’Ÿ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <span id="statusText">å°±ç»ª - AIçŸ¥è¯†åº“åŠ©æ‰‹ v1.0 Enhanced</span>
            <span style="margin-left: auto;" id="editorInfo">Monaco Editor</span>
        </div>
    </div>
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <span class="settings-title">âš™ï¸ è®¾ç½®</span>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <div class="settings-tabs">
                <button class="tab-btn active" onclick="switchTab('basic')">åŸºæœ¬è®¾ç½®</button>
                <button class="tab-btn" onclick="switchTab('backup')">å¤‡ä»½ç®¡ç†</button>
                <button class="tab-btn" onclick="switchTab('prompt')">Promptæ¨¡æ¿</button>
            </div>
            
            <!-- åŸºæœ¬è®¾ç½®é€‰é¡¹å¡ -->
            <div id="basicTab" class="tab-content active">
                <form id="settingsForm">
                <div class="form-group">
                    <label class="form-label" for="knowledgeBasePath">çŸ¥è¯†åº“è·¯å¾„</label>
                    <input type="text" id="knowledgeBasePath" class="form-input" placeholder="ä¾‹å¦‚: D:\\Documents\\MyNotes">
                    <div class="form-help">è®¾ç½®æ‚¨çš„çŸ¥è¯†åº“æ ¹ç›®å½•è·¯å¾„ï¼ŒAIå°†åŸºäºæ­¤è·¯å¾„åˆ†ææ‚¨çš„ç¬”è®°</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="openrouterApiKey">OpenRouter API Key</label>
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <input type="password" id="openrouterApiKey" class="form-input" placeholder="sk-or-v1-..." style="flex: 1;">
                        <button type="button" id="validateApiKey" class="btn btn-small" onclick="validateApiKey()" style="white-space: nowrap;">ğŸ” æ ¡éªŒ</button>
                        <button type="button" id="testNotification" class="btn btn-small" onclick="showNotification('æµ‹è¯•é€šçŸ¥', 'info')" style="white-space: nowrap;">æµ‹è¯•</button>
                    </div>
                    <div class="form-help">æ‚¨çš„OpenRouter APIå¯†é’¥ï¼Œç”¨äºè®¿é—®AIæ¨¡å‹ã€‚<a href="https://openrouter.ai/keys" target="_blank" style="color: #007acc;">è·å–API Key</a></div>
                    <div id="apiValidationResult" style="margin-top: 8px; font-size: 12px;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="aiModel">AI æ¨¡å‹</label>
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <select id="aiModel" class="form-input" style="flex: 1;">
                            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (æ¨è)</option>
                            <option value="openai/gpt-4o">GPT-4o</option>
                            <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                            <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                        </select>
                        <button type="button" id="refreshModels" class="btn btn-small" onclick="refreshModelList()" style="white-space: nowrap;">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="form-help">é€‰æ‹©è¦ä½¿ç”¨çš„AIæ¨¡å‹ã€‚ç‚¹å‡»åˆ·æ–°æŒ‰é’®è·å–æœ€æ–°çš„å¯ç”¨æ¨¡å‹åˆ—è¡¨ã€‚</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="autoBackup">è‡ªåŠ¨å¤‡ä»½</label>
                    <select id="autoBackup" class="form-input">
                        <option value="true">å¯ç”¨</option>
                        <option value="false">ç¦ç”¨</option>
                    </select>
                    <div class="form-help">è‡ªåŠ¨å¤‡ä»½æ‚¨çš„è®¾ç½®å’Œé‡è¦æ•°æ®</div>
                </div>
                </form>
                
                <div class="settings-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
            
            <!-- å¤‡ä»½ç®¡ç†é€‰é¡¹å¡ -->
            <div id="backupTab" class="tab-content">
                <div class="backup-section">
                    <h3>ğŸ“¦ æ•°æ®å¤‡ä»½</h3>
                    <p class="backup-info">ç³»ç»Ÿä¼šè‡ªåŠ¨å¤‡ä»½æ‚¨çš„è®¾ç½®ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºå¤‡ä»½æˆ–æ¢å¤å†å²å¤‡ä»½ã€‚</p>
                    
                    <div class="backup-actions">
                        <button type="button" class="btn btn-primary" onclick="createManualBackup()">ğŸ”„ åˆ›å»ºå¤‡ä»½</button>
                        <button type="button" class="btn btn-secondary" onclick="refreshBackupList()">ğŸ“‹ åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    
                    <div class="backup-list">
                        <h4>å¤‡ä»½å†å²</h4>
                        <div id="backupListContainer">
                            <div class="loading">æ­£åœ¨åŠ è½½å¤‡ä»½åˆ—è¡¨...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Promptæ¨¡æ¿é€‰é¡¹å¡ -->
            <div id="promptTab" class="tab-content">
                <div class="prompt-section">
                    <h3>ğŸ¯ Prompt æ¨¡æ¿ç®¡ç†</h3>
                    <p class="backup-info">è‡ªå®šä¹‰AIäº¤äº’çš„Promptæ¨¡æ¿ï¼Œæé«˜AIå“åº”çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚</p>
                    
                    <div class="prompt-actions">
                        <button type="button" class="btn btn-primary" onclick="addPromptTemplate()">â• æ·»åŠ æ¨¡æ¿</button>
                        <button type="button" class="btn btn-secondary" onclick="resetDefaultTemplates()">ğŸ”„ é‡ç½®é»˜è®¤</button>
                    </div>
                    
                    <div class="prompt-list">
                        <h4>æ¨¡æ¿åˆ—è¡¨</h4>
                        <div id="promptTemplateList">
                            <div class="loading">æ­£åœ¨åŠ è½½æ¨¡æ¿åˆ—è¡¨...</div>
                        </div>
                    </div>
                    
                    <!-- ç¼–è¾‘æ¨¡æ¿æ¨¡æ€æ¡† -->
                    <div id="promptEditModal" class="modal" style="display: none;">
                        <div class="modal-content" style="max-width: 800px;">
                            <div class="settings-header">
                                <h3 class="settings-title">ç¼–è¾‘ Prompt æ¨¡æ¿</h3>
                                <button class="close-btn" onclick="closePromptEditModal()">&times;</button>
                            </div>
                            
                            <form id="promptEditForm">
                                <div class="form-group">
                                    <label class="form-label" for="promptName">æ¨¡æ¿åç§°</label>
                                    <input type="text" id="promptName" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ€»ç»“æ–‡æ¡£">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="promptDescription">æ¨¡æ¿æè¿°</label>
                                    <input type="text" id="promptDescription" class="form-input" placeholder="ç®€è¦æè¿°æ­¤æ¨¡æ¿çš„ç”¨é€”">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="promptContent">Prompt å†…å®¹</label>
                                    <textarea id="promptContent" class="form-input" rows="8" placeholder="è¯·è¾“å…¥Promptæ¨¡æ¿å†…å®¹...\n\nå¯ä»¥ä½¿ç”¨å˜é‡ï¼š\n{content} - å½“å‰æ–‡æ¡£å†…å®¹\n{filename} - æ–‡ä»¶å\n{selection} - é€‰ä¸­çš„æ–‡æœ¬"></textarea>
                                    <div class="form-help">æ”¯æŒå˜é‡æ›¿æ¢ï¼š{content}ã€{filename}ã€{selection}</div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="promptCategory">åˆ†ç±»</label>
                                    <select id="promptCategory" class="form-input">
                                        <option value="summary">æ€»ç»“</option>
                                        <option value="analysis">åˆ†æ</option>
                                        <option value="planning">è§„åˆ’</option>
                                        <option value="writing">å†™ä½œ</option>
                                        <option value="custom">è‡ªå®šä¹‰</option>
                                    </select>
                                </div>
                            </form>
                            
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closePromptEditModal()">å–æ¶ˆ</button>
                                <button type="button" class="btn btn-primary" onclick="savePromptTemplate()">ä¿å­˜</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    
    <script>
        // å…¨å±€å‡½æ•°ï¼šæ ¡éªŒAPIå¯†é’¥
        async function validateApiKey() {
            console.log('validateApiKey function called');
            const apiKeyInput = document.getElementById('openrouterApiKey');
            const resultDiv = document.getElementById('apiValidationResult');
            const validateBtn = document.getElementById('validateApiKey');
            
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                resultDiv.innerHTML = '<span style="color: #f48771;">âŒ è¯·è¾“å…¥APIå¯†é’¥</span>';
                showNotification('è¯·è¾“å…¥APIå¯†é’¥', 'warning');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            validateBtn.disabled = true;
            validateBtn.innerHTML = '<span class="loading-spinner">â—</span> æ ¡éªŒä¸­...';
            resultDiv.innerHTML = '<span style="color: #007acc;">ğŸ”„ æ­£åœ¨æ ¡éªŒAPIå¯†é’¥...</span>';
            
            try {
                // è°ƒç”¨OpenRouter APIè·å–æ¨¡å‹åˆ—è¡¨æ¥éªŒè¯å¯†é’¥
                const response = await fetch('https://openrouter.ai/api/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<span style="color: #4ec9b0;">âœ… APIå¯†é’¥æœ‰æ•ˆï¼å¯è®¿é—® ${data.data ? data.data.length : 0} ä¸ªæ¨¡å‹</span>`;
                    updateStatus('APIå¯†é’¥æ ¡éªŒæˆåŠŸ', 'success');
                    showNotification('APIå¯†é’¥æ ¡éªŒæˆåŠŸï¼å·²è‡ªåŠ¨åˆ·æ–°æ¨¡å‹åˆ—è¡¨', 'success');
                    
                    // è‡ªåŠ¨åˆ·æ–°æ¨¡å‹åˆ—è¡¨
                    setTimeout(() => {
                        refreshModelList();
                    }, 500);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.error?.message || response.statusText;
                    resultDiv.innerHTML = `<span style="color: #f48771;">âŒ APIå¯†é’¥æ— æ•ˆ: ${errorMsg}</span>`;
                    updateStatus('APIå¯†é’¥æ ¡éªŒå¤±è´¥', 'error');
                    showNotification(`APIå¯†é’¥æ— æ•ˆ: ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('APIå¯†é’¥æ ¡éªŒå¤±è´¥:', error);
                const errorMsg = error.message || 'ç½‘ç»œè¿æ¥å¤±è´¥';
                resultDiv.innerHTML = `<span style="color: #f48771;">âŒ æ ¡éªŒå¤±è´¥: ${errorMsg}</span>`;
                updateStatus('APIå¯†é’¥æ ¡éªŒå¤±è´¥: ' + errorMsg, 'error');
                showNotification(`æ ¡éªŒå¤±è´¥: ${errorMsg}ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                validateBtn.disabled = false;
                validateBtn.innerHTML = 'ğŸ” æ ¡éªŒ';
            }
        }
        
        let currentFilePath = null;
        let currentFolderPath = null;
        let isPreviewMode = false;
        let isDarkTheme = true;
        let monacoEditor = null;
        
        // åˆå§‹åŒ–Monaco Editor
        function initMonacoEditor() {
            require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
            
            require(['vs/editor/editor.main'], function () {
                monacoEditor = monaco.editor.create(document.getElementById('monacoContainer'), {
                    value: '# æ¬¢è¿ä½¿ç”¨ AI çŸ¥è¯†åº“åŠ©æ‰‹\n\nè¯·é€‰æ‹©ä¸€ä¸ªMarkdownæ–‡ä»¶å¼€å§‹ç¼–è¾‘...\n\n## å¿«æ·é”®\n- **Ctrl+S**: ä¿å­˜æ–‡ä»¶\n- **Ctrl+P**: åˆ‡æ¢é¢„è§ˆæ¨¡å¼\n- **Alt+Shift+F**: æ ¼å¼åŒ–æ–‡æ¡£\n- **Ctrl+F**: æŸ¥æ‰¾\n- **Ctrl+H**: æŸ¥æ‰¾æ›¿æ¢\n\n## åŠŸèƒ½ç‰¹æ€§\n- ğŸ¨ Monaco Editor ä»£ç ç¼–è¾‘å™¨\n- ğŸ‘ï¸ å®æ—¶Markdowné¢„è§ˆ\n- ğŸ—‚ï¸ æ–‡ä»¶æ ‘æµè§ˆ\n- ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹ï¼ˆå³å°†ä¸Šçº¿ï¼‰',
                    language: 'markdown',
                    theme: isDarkTheme ? 'vs-dark' : 'vs',
                    automaticLayout: true,
                    wordWrap: 'on',
                    minimap: { enabled: true },
                    fontSize: 14,
                    lineNumbers: 'on',
                    renderWhitespace: 'selection',
                    scrollBeyondLastLine: false,
                    folding: true,
                    links: true,
                    colorDecorators: true
                });
                
                // ç›‘å¬å†…å®¹å˜åŒ–
                monacoEditor.onDidChangeModelContent(() => {
                    if (isPreviewMode && currentFilePath && currentFilePath.endsWith('.md')) {
                        updatePreview();
                    }
                    updateEditorInfo();
                });
                
                // æ·»åŠ è‡ªå®šä¹‰å¿«æ·é”®
                monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, saveFile);
                monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyP, togglePreview);
                monacoEditor.addCommand(monaco.KeyMod.Alt | monaco.KeyMod.Shift | monaco.KeyCode.KeyF, formatDocument);
                
                updateStatus('Monaco Editor å·²åŠ è½½å®Œæˆ');
                updateEditorInfo();
            });
        }
        
        // åŠ è½½æŒ‡å®šè·¯å¾„
        async function loadPath() {
            const pathInput = document.getElementById('pathInput');
            const path = pathInput.value.trim();
            
            if (!path) {
                updateStatus('è¯·è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„');
                return;
            }
            
            currentFolderPath = path;
            await loadFileTree(path);
        }
        
        // æ–‡ä»¶æ ‘æ•°æ®ç»“æ„
        let fileTreeData = {};
        let expandedFolders = new Set();
        
        // åŠ è½½æ–‡ä»¶æ ‘
        async function loadFileTree(folderPath) {
            const fileTreeElement = document.getElementById('fileTree');
            fileTreeElement.innerHTML = '<div class="loading">ğŸ”„ æ­£åœ¨åŠ è½½æ–‡ä»¶æ ‘...</div>';
            
            try {
                const response = await fetch(`/api/read-directory?path=${encodeURIComponent(folderPath)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }
                
                // æ„å»ºæ ‘å½¢æ•°æ®ç»“æ„
                fileTreeData = {
                    name: folderPath.split(/[\\/]/).pop() || folderPath,
                    path: folderPath,
                    isDirectory: true,
                    children: data.sort((a, b) => {
                        if (a.isDirectory && !b.isDirectory) return -1;
                        if (!a.isDirectory && b.isDirectory) return 1;
                        return a.name.localeCompare(b.name);
                    })
                };
                
                expandedFolders.add(folderPath);
                renderFileTree();
                
                updateStatus(`âœ… å·²åŠ è½½æ–‡ä»¶å¤¹: ${folderPath} (${data.length} é¡¹)`);
                
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥:', error);
                fileTreeElement.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
                updateStatus('âŒ åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥');
            }
        }
        
        // æ¸²æŸ“æ–‡ä»¶æ ‘
        function renderFileTree() {
            const fileTreeElement = document.getElementById('fileTree');
            fileTreeElement.innerHTML = '';
            
            if (fileTreeData.children) {
                renderTreeNode(fileTreeData, fileTreeElement, 0);
            }
        }
        
        // æ¸²æŸ“æ ‘èŠ‚ç‚¹
        function renderTreeNode(node, container, depth) {
            if (node.children) {
                // æ¸²æŸ“æ–‡ä»¶å¤¹
                node.children.forEach(child => {
                    // è¿‡æ»¤ä»¥ç‚¹å¼€å¤´çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
                    if (child.name.startsWith('.')) {
                        return;
                    }
                    const itemContainer = document.createElement('div');
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    // ç¼©è¿›
                    for (let i = 0; i < depth; i++) {
                        const indent = document.createElement('span');
                        indent.className = 'tree-indent';
                        fileItem.appendChild(indent);
                    }
                    
                    if (child.isDirectory) {
                        // æ–‡ä»¶å¤¹
                        fileItem.className += ' directory';
                        
                        const expandIcon = document.createElement('span');
                        expandIcon.className = 'expand-icon';
                        expandIcon.innerHTML = 'â–¶';
                        
                        const isExpanded = expandedFolders.has(child.path);
                        if (isExpanded) {
                            expandIcon.classList.add('expanded');
                        }
                        
                        expandIcon.onclick = (e) => {
                            e.stopPropagation();
                            toggleFolder(child.path);
                        };
                        
                        // è®¾ç½®å±•å¼€å›¾æ ‡çš„æ•°æ®å±æ€§ï¼Œç”¨äºåç»­æ›´æ–°
                        expandIcon.setAttribute('data-path', child.path);
                        
                        fileItem.appendChild(expandIcon);
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.innerHTML = `ğŸ“ ${child.name}`;
                        nameSpan.onclick = () => {
                            document.getElementById('pathInput').value = child.path;
                            loadFileTree(child.path);
                        };
                        fileItem.appendChild(nameSpan);
                        
                        itemContainer.appendChild(fileItem);
                        
                        // å­æ–‡ä»¶å¤¹å®¹å™¨
                        if (isExpanded && child.children) {
                            const childrenContainer = document.createElement('div');
                            childrenContainer.className = 'file-children expanded';
                            renderTreeNode(child, childrenContainer, depth + 1);
                            itemContainer.appendChild(childrenContainer);
                        }
                        
                    } else {
                        // æ–‡ä»¶
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'file-content';
                        
                        if (child.name.endsWith('.md')) {
                            fileItem.className += ' markdown';
                            const modifiedDate = new Date(child.modified).toLocaleDateString('zh-CN');
                            const modifiedTime = new Date(child.modified).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                            nameSpan.innerHTML = `
                                ğŸ“„ ${child.name}
                                <div class="file-meta">${modifiedDate} ${modifiedTime}</div>
                            `;
                        } else {
                            const ext = child.name.split('.').pop().toLowerCase();
                            const icon = getFileIcon(ext);
                            nameSpan.innerHTML = `${icon} ${child.name}`;
                        }
                        
                        fileItem.appendChild(nameSpan);
                        fileItem.onclick = () => openFile(child.path, fileItem);
                        itemContainer.appendChild(fileItem);
                    }
                    
                    container.appendChild(itemContainer);
                });
            }
        }
        
        // åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€çŠ¶æ€
        async function toggleFolder(folderPath) {
            if (expandedFolders.has(folderPath)) {
                expandedFolders.delete(folderPath);
            } else {
                expandedFolders.add(folderPath);
                
                // å¦‚æœæ–‡ä»¶å¤¹è¿˜æ²¡æœ‰åŠ è½½å­é¡¹ï¼Œåˆ™åŠ è½½
                const folderNode = findNodeByPath(fileTreeData, folderPath);
                if (folderNode && !folderNode.children) {
                    try {
                        const response = await fetch(`/api/read-directory?path=${encodeURIComponent(folderPath)}`);
                        const data = await response.json();
                        
                        if (response.ok) {
                            folderNode.children = data.sort((a, b) => {
                                if (a.isDirectory && !b.isDirectory) return -1;
                                if (!a.isDirectory && b.isDirectory) return 1;
                                return a.name.localeCompare(b.name);
                            });
                        }
                    } catch (error) {
                        console.error('åŠ è½½å­æ–‡ä»¶å¤¹å¤±è´¥:', error);
                    }
                }
            }
            
            // æ›´æ–°å±•å¼€å›¾æ ‡çŠ¶æ€
            updateExpandIcons();
            renderFileTree();
        }
        
        // æ›´æ–°æ‰€æœ‰å±•å¼€å›¾æ ‡çš„çŠ¶æ€
        function updateExpandIcons() {
            const expandIcons = document.querySelectorAll('.expand-icon[data-path]');
            expandIcons.forEach(icon => {
                const path = icon.getAttribute('data-path');
                if (expandedFolders.has(path)) {
                    icon.classList.add('expanded');
                } else {
                    icon.classList.remove('expanded');
                }
            });
        }
        
        // æ ¹æ®è·¯å¾„æŸ¥æ‰¾èŠ‚ç‚¹
        function findNodeByPath(node, targetPath) {
            if (node.path === targetPath) {
                return node;
            }
            
            if (node.children) {
                for (const child of node.children) {
                    const found = findNodeByPath(child, targetPath);
                    if (found) return found;
                }
            }
            
            return null;
        }
        
        // åˆ‡æ¢ä¾§è¾¹æ æŠ˜å çŠ¶æ€
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const collapseBtn = sidebar.querySelector('.collapse-btn');
            
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                collapseBtn.innerHTML = 'â—€';
                collapseBtn.title = 'æŠ˜å ä¾§è¾¹æ ';
            } else {
                sidebar.classList.add('collapsed');
                collapseBtn.innerHTML = 'â–¶';
                collapseBtn.title = 'å±•å¼€ä¾§è¾¹æ ';
            }
        }
        
        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(ext) {
            const icons = {
                'md': 'ğŸ“„', 'txt': 'ğŸ“„', 'doc': 'ğŸ“„', 'docx': 'ğŸ“„',
                'js': 'ğŸ“œ', 'ts': 'ğŸ“œ', 'html': 'ğŸŒ', 'css': 'ğŸ¨',
                'json': 'âš™ï¸', 'xml': 'âš™ï¸', 'yml': 'âš™ï¸', 'yaml': 'âš™ï¸',
                'png': 'ğŸ–¼ï¸', 'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
                'pdf': 'ğŸ“•', 'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦'
            };
            return icons[ext] || 'ğŸ“„';
        }
        
        // æ‰“å¼€æ–‡ä»¶
        async function openFile(filePath, element) {
            try {
                updateStatus('ğŸ”„ æ­£åœ¨æ‰“å¼€æ–‡ä»¶...');
                
                const response = await fetch(`/api/read-file?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'æ‰“å¼€æ–‡ä»¶å¤±è´¥');
                }
                
                if (monacoEditor) {
                    monacoEditor.setValue(data.content);
                    
                    // è®¾ç½®è¯­è¨€æ¨¡å¼
                    const ext = filePath.split('.').pop().toLowerCase();
                    const language = getLanguageByExtension(ext);
                    monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
                }
                
                currentFilePath = filePath;
                
                // æ›´æ–°å½“å‰æ–‡ä»¶æ˜¾ç¤º
                const fileName = filePath.split(/[\\/]/).pop();
                document.getElementById('currentFile').textContent = fileName;
                
                // é«˜äº®é€‰ä¸­çš„æ–‡ä»¶
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('selected');
                });
                if (element) {
                    element.classList.add('selected');
                }
                
                // å¦‚æœæ˜¯é¢„è§ˆæ¨¡å¼ï¼Œæ›´æ–°é¢„è§ˆ
                if (isPreviewMode && filePath.endsWith('.md')) {
                    updatePreview();
                }
                
                updateStatus(`âœ… å·²æ‰“å¼€: ${fileName}`);
                updateEditorInfo();
            } catch (error) {
                console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error);
                updateStatus(`âŒ æ‰“å¼€æ–‡ä»¶å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ ¹æ®æ–‡ä»¶æ‰©å±•åè·å–è¯­è¨€
        function getLanguageByExtension(ext) {
            const languages = {
                'md': 'markdown', 'txt': 'plaintext',
                'js': 'javascript', 'ts': 'typescript',
                'html': 'html', 'css': 'css',
                'json': 'json', 'xml': 'xml',
                'py': 'python', 'java': 'java',
                'cpp': 'cpp', 'c': 'c',
                'cs': 'csharp', 'php': 'php',
                'rb': 'ruby', 'go': 'go',
                'rs': 'rust', 'swift': 'swift'
            };
            return languages[ext] || 'plaintext';
        }
        
        // ä¿å­˜æ–‡ä»¶
        async function saveFile() {
            if (!currentFilePath) {
                updateStatus('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            
            try {
                updateStatus('ğŸ’¾ æ­£åœ¨ä¿å­˜æ–‡ä»¶...');
                
                const content = monacoEditor ? monacoEditor.getValue() : '';
                const response = await fetch('/api/write-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: currentFilePath,
                        content: content
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
                }
                
                updateStatus('âœ… æ–‡ä»¶å·²ä¿å­˜');
                
                // å¦‚æœæ˜¯é¢„è§ˆæ¨¡å¼ï¼Œæ›´æ–°é¢„è§ˆ
                if (isPreviewMode && currentFilePath.endsWith('.md')) {
                    updatePreview();
                }
                
            } catch (error) {
                console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
                updateStatus(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }
        
        // åˆ‡æ¢é¢„è§ˆæ¨¡å¼
        function togglePreview() {
            const monacoContainer = document.getElementById('monacoContainer');
            const preview = document.getElementById('preview');
            const previewBtn = document.getElementById('previewBtn');
            
            isPreviewMode = !isPreviewMode;
            
            if (isPreviewMode) {
                monacoContainer.style.flex = '1';
                preview.style.display = 'block';
                previewBtn.classList.add('active');
                previewBtn.innerHTML = 'ğŸ“ ç¼–è¾‘';
                
                if (currentFilePath && currentFilePath.endsWith('.md')) {
                    updatePreview();
                } else {
                    preview.innerHTML = '<p style="color: #a0a0a0; text-align: center; margin-top: 50px;">ğŸ“„ è¯·é€‰æ‹©Markdownæ–‡ä»¶ä»¥æŸ¥çœ‹é¢„è§ˆ</p>';
                }
                
                updateStatus('ğŸ‘ï¸ å·²åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼');
            } else {
                preview.style.display = 'none';
                previewBtn.classList.remove('active');
                previewBtn.innerHTML = 'ğŸ‘ï¸ é¢„è§ˆ';
                updateStatus('ğŸ“ å·²åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼');
            }
        }
        
        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            if (monacoEditor) {
                monaco.editor.setTheme(isDarkTheme ? 'vs-dark' : 'vs');
            }
            
            // åˆ‡æ¢é¡µé¢ä¸»é¢˜
            document.body.style.backgroundColor = isDarkTheme ? '#1e1e1e' : '#ffffff';
            document.body.style.color = isDarkTheme ? '#cccccc' : '#333333';
            
            updateStatus(`ğŸŒ“ å·²åˆ‡æ¢åˆ°${isDarkTheme ? 'æ·±è‰²' : 'æµ…è‰²'}ä¸»é¢˜`);
        }
        
        // æ ¼å¼åŒ–æ–‡æ¡£
        function formatDocument() {
            if (monacoEditor) {
                monacoEditor.getAction('editor.action.formatDocument').run();
                updateStatus('âœ¨ æ–‡æ¡£å·²æ ¼å¼åŒ–');
            }
        }
        
        // æ›´æ–°Markdowné¢„è§ˆ
        function updatePreview() {
            if (!monacoEditor) return;
            
            const content = monacoEditor.getValue();
            const preview = document.getElementById('preview');
            
            // å¢å¼ºçš„Markdownæ¸²æŸ“
            let html = content
                // ä»£ç å—
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // æ ‡é¢˜
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // ç²—ä½“å’Œæ–œä½“
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                // è¡Œå†…ä»£ç 
                .replace(/`(.*?)`/gim, '<code>$1</code>')
                // å¼•ç”¨
                .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                // åˆ—è¡¨
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                // é“¾æ¥
                .replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                // æ¢è¡Œ
                .replace(/\n/gim, '<br>');
            
            // åŒ…è£…åˆ—è¡¨é¡¹
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            preview.innerHTML = html || '<p style="color: #a0a0a0;">ğŸ“„ é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>';
        }
        
        // åˆ·æ–°æ–‡ä»¶æ ‘
        function refreshFileTree() {
            if (currentFolderPath) {
                loadFileTree(currentFolderPath);
            } else {
                updateStatus('âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹');
            }
        }
        
        // æ›´æ–°ç¼–è¾‘å™¨ä¿¡æ¯
        function updateEditorInfo() {
            if (!monacoEditor) return;
            
            const model = monacoEditor.getModel();
            const position = monacoEditor.getPosition();
            const lineCount = model.getLineCount();
            const language = model.getLanguageId();
            
            document.getElementById('editorInfo').textContent = 
                `${language.toUpperCase()} | è¡Œ ${position.lineNumber}, åˆ— ${position.column} | å…± ${lineCount} è¡Œ`;
        }
        
        // AIåŠŸèƒ½ï¼ˆæ¼”ç¤ºï¼‰
        // ç”Ÿæˆæ¯æ—¥è§„åˆ’
        async function generateDailyPlan() {
            const aiOutput = document.getElementById('aiOutput');
            
            try {
                // æ£€æŸ¥è®¾ç½®
                const settings = getCurrentSettings();
                if (!settings.openrouterApiKey) {
                    aiOutput.innerHTML = `
                        <h4>âš ï¸ é…ç½®æé†’</h4>
                        <p style="color: #f48771;">è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®OpenRouter API Key</p>
                        <button class="btn btn-primary" onclick="openSettings()" style="margin-top: 10px;">æ‰“å¼€è®¾ç½®</button>
                    `;
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                aiOutput.innerHTML = `
                    <h4>ğŸ“… æ­£åœ¨ç”Ÿæˆæ¯æ—¥è§„åˆ’...</h4>
                    <div style="display: flex; align-items: center; margin: 20px 0;">
                        <div style="width: 20px; height: 20px; border: 2px solid #007acc; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                        <span>AIæ­£åœ¨åˆ†ææ‚¨çš„çŸ¥è¯†åº“...</span>
                    </div>
                `;
                
                updateStatus('ğŸ¤– æ­£åœ¨ç”Ÿæˆæ¯æ—¥è§„åˆ’...');
                
                // æ„å»ºä¸Šä¸‹æ–‡
                const context = {
                    knowledgeBasePath: settings.knowledgeBasePath,
                    currentFile: currentFilePath,
                    additionalContext: currentFilePath ? `å½“å‰æ­£åœ¨ç¼–è¾‘: ${currentFilePath}` : ''
                };
                
                // è°ƒç”¨API
                const response = await aiApiService.generateDailyPlan(context);
                const content = response.choices[0].message.content;
                
                // æ˜¾ç¤ºç»“æœ
                aiOutput.innerHTML = `
                    <h4>ğŸ“… ä»Šæ—¥è§„åˆ’</h4>
                    <div style="background-color: #1e1e1e; padding: 15px; border-radius: 4px; border: 1px solid #3e3e42; margin: 10px 0;">
                        ${markdownToHtml(content)}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="insertPlanToNote()" style="margin-right: 10px;">æ’å…¥åˆ°ä»Šæ—¥ç¬”è®°</button>
                        <button class="btn btn-secondary" onclick="generateDailyPlan()">é‡æ–°ç”Ÿæˆ</button>
                    </div>
                `;
                
                updateStatus('âœ… æ¯æ—¥è§„åˆ’ç”Ÿæˆå®Œæˆ');
                
            } catch (error) {
                console.error('ç”Ÿæˆæ¯æ—¥è§„åˆ’å¤±è´¥:', error);
                aiOutput.innerHTML = `
                    <h4>âŒ ç”Ÿæˆå¤±è´¥</h4>
                    <p style="color: #f48771;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    <button class="btn btn-secondary" onclick="generateDailyPlan()" style="margin-top: 10px;">é‡è¯•</button>
                `;
                updateStatus('âŒ æ¯æ—¥è§„åˆ’ç”Ÿæˆå¤±è´¥');
            }
        }
        
        // æ•´åˆæ€æƒ³ç¢ç‰‡
        async function integrateThoughts() {
            const aiOutput = document.getElementById('aiOutput');
            
            try {
                // æ£€æŸ¥è®¾ç½®
                const settings = getCurrentSettings();
                if (!settings.openrouterApiKey) {
                    aiOutput.innerHTML = `
                        <h4>âš ï¸ é…ç½®æé†’</h4>
                        <p style="color: #f48771;">è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®OpenRouter API Key</p>
                        <button class="btn btn-primary" onclick="openSettings()" style="margin-top: 10px;">æ‰“å¼€è®¾ç½®</button>
                    `;
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                aiOutput.innerHTML = `
                    <h4>ğŸ’¡ æ­£åœ¨æ•´åˆæ€æƒ³ç¢ç‰‡...</h4>
                    <div style="display: flex; align-items: center; margin: 20px 0;">
                        <div style="width: 20px; height: 20px; border: 2px solid #007acc; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                        <span>AIæ­£åœ¨åˆ†ææ€æƒ³ç¢ç‰‡...</span>
                    </div>
                `;
                
                updateStatus('ğŸ¤– æ­£åœ¨æ•´åˆæ€æƒ³ç¢ç‰‡...');
                
                // å°è¯•è¯»å–Quick Capture.md
                let fragments = '';
                const quickCapturePath = settings.knowledgeBasePath ? `${settings.knowledgeBasePath}/Quick Capture.md` : null;
                
                if (quickCapturePath) {
                    try {
                        const response = await fetch('/api/read-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePath: quickCapturePath })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            fragments = data.content;
                        }
                    } catch (error) {
                        console.log('æ— æ³•è¯»å–Quick Capture.mdï¼Œä½¿ç”¨å½“å‰æ–‡æ¡£å†…å®¹');
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°Quick Capture.mdï¼Œä½¿ç”¨å½“å‰ç¼–è¾‘å™¨å†…å®¹
                if (!fragments && monacoEditor) {
                    fragments = monacoEditor.getValue();
                }
                
                if (!fragments.trim()) {
                    aiOutput.innerHTML = `
                        <h4>âš ï¸ æ²¡æœ‰æ‰¾åˆ°å†…å®¹</h4>
                        <p style="color: #f48771;">è¯·ç¡®ä¿Quick Capture.mdæ–‡ä»¶å­˜åœ¨ï¼Œæˆ–åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€ä¸€äº›å†…å®¹</p>
                    `;
                    return;
                }
                
                // è°ƒç”¨API
                const response = await aiApiService.integrateThoughts(fragments);
                const content = response.choices[0].message.content;
                
                // æ˜¾ç¤ºç»“æœ
                aiOutput.innerHTML = `
                    <h4>ğŸ’¡ æ€æƒ³æ•´åˆåˆ†æ</h4>
                    <div style="background-color: #1e1e1e; padding: 15px; border-radius: 4px; border: 1px solid #3e3e42; margin: 10px 0;">
                        ${markdownToHtml(content)}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="appendToCurrentNote()" style="margin-right: 10px;">è¿½åŠ åˆ°å½“å‰ç¬”è®°</button>
                        <button class="btn btn-secondary" onclick="integrateThoughts()">é‡æ–°åˆ†æ</button>
                    </div>
                `;
                
                updateStatus('âœ… æ€æƒ³æ•´åˆå®Œæˆ');
                
            } catch (error) {
                console.error('æ€æƒ³æ•´åˆå¤±è´¥:', error);
                aiOutput.innerHTML = `
                    <h4>âŒ æ•´åˆå¤±è´¥</h4>
                    <p style="color: #f48771;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    <button class="btn btn-secondary" onclick="integrateThoughts()" style="margin-top: 10px;">é‡è¯•</button>
                `;
                updateStatus('âŒ æ€æƒ³æ•´åˆå¤±è´¥');
            }
        }
        
        // å†…å®¹åˆ†æ
        async function analyzeContent() {
            const aiOutput = document.getElementById('aiOutput');
            
            try {
                // æ£€æŸ¥è®¾ç½®
                const settings = getCurrentSettings();
                if (!settings.openrouterApiKey) {
                    aiOutput.innerHTML = `
                        <h4>âš ï¸ é…ç½®æé†’</h4>
                        <p style="color: #f48771;">è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®OpenRouter API Key</p>
                        <button class="btn btn-primary" onclick="openSettings()" style="margin-top: 10px;">æ‰“å¼€è®¾ç½®</button>
                    `;
                    return;
                }
                
                // è·å–å½“å‰å†…å®¹
                if (!monacoEditor || !monacoEditor.getValue().trim()) {
                    aiOutput.innerHTML = `
                        <h4>âš ï¸ æ²¡æœ‰å†…å®¹</h4>
                        <p style="color: #f48771;">è¯·å…ˆåœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€æˆ–è¾“å…¥ä¸€äº›å†…å®¹</p>
                    `;
                    return;
                }
                
                const content = monacoEditor.getValue();
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                aiOutput.innerHTML = `
                    <h4>ğŸ“Š æ­£åœ¨åˆ†æå†…å®¹...</h4>
                    <div style="display: flex; align-items: center; margin: 20px 0;">
                        <div style="width: 20px; height: 20px; border: 2px solid #007acc; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                        <span>AIæ­£åœ¨æ·±åº¦åˆ†æå†…å®¹...</span>
                    </div>
                `;
                
                updateStatus('ğŸ¤– æ­£åœ¨åˆ†æå†…å®¹...');
                
                // è°ƒç”¨API
                const response = await aiApiService.analyzeContent(content);
                const analysisResult = response.choices[0].message.content;
                
                // æ˜¾ç¤ºç»“æœ
                aiOutput.innerHTML = `
                    <h4>ğŸ“Š å†…å®¹åˆ†ææŠ¥å‘Š</h4>
                    <div style="background-color: #1e1e1e; padding: 15px; border-radius: 4px; border: 1px solid #3e3e42; margin: 10px 0;">
                        ${markdownToHtml(analysisResult)}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="generateSummary()" style="margin-right: 10px;">ç”Ÿæˆæ‘˜è¦</button>
                        <button class="btn btn-secondary" onclick="analyzeContent()">é‡æ–°åˆ†æ</button>
                    </div>
                `;
                
                updateStatus('âœ… å†…å®¹åˆ†æå®Œæˆ');
                
            } catch (error) {
                console.error('å†…å®¹åˆ†æå¤±è´¥:', error);
                aiOutput.innerHTML = `
                    <h4>âŒ åˆ†æå¤±è´¥</h4>
                    <p style="color: #f48771;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    <button class="btn btn-secondary" onclick="analyzeContent()" style="margin-top: 10px;">é‡è¯•</button>
                `;
                updateStatus('âŒ å†…å®¹åˆ†æå¤±è´¥');
            }
        }
        
        // ç”Ÿæˆæ‘˜è¦
        async function generateSummary() {
            const aiOutput = document.getElementById('aiOutput');
            
            try {
                // æ£€æŸ¥è®¾ç½®
                const settings = getCurrentSettings();
                if (!settings.openrouterApiKey) {
                    aiOutput.innerHTML = `
                        <h4>âš ï¸ é…ç½®æé†’</h4>
                        <p style="color: #f48771;">è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®OpenRouter API Key</p>
                        <button class="btn btn-primary" onclick="openSettings()" style="margin-top: 10px;">æ‰“å¼€è®¾ç½®</button>
                    `;
                    return;
                }
                
                // è·å–å½“å‰å†…å®¹
                if (!monacoEditor || !monacoEditor.getValue().trim()) {
                    aiOutput.innerHTML = `
                        <h4>âš ï¸ æ²¡æœ‰å†…å®¹</h4>
                        <p style="color: #f48771;">è¯·å…ˆåœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€æˆ–è¾“å…¥ä¸€äº›å†…å®¹</p>
                    `;
                    return;
                }
                
                const content = monacoEditor.getValue();
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                aiOutput.innerHTML = `
                    <h4>ğŸ“ æ­£åœ¨ç”Ÿæˆæ‘˜è¦...</h4>
                    <div style="display: flex; align-items: center; margin: 20px 0;">
                        <div style="width: 20px; height: 20px; border: 2px solid #007acc; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                        <span>AIæ­£åœ¨æå–å…³é”®ä¿¡æ¯...</span>
                    </div>
                `;
                
                updateStatus('ğŸ¤– æ­£åœ¨ç”Ÿæˆæ‘˜è¦...');
                
                // è°ƒç”¨API
                const response = await aiApiService.analyzeContent(content, 'summary');
                const summary = response.choices[0].message.content;
                
                // æ˜¾ç¤ºç»“æœ
                aiOutput.innerHTML = `
                    <h4>ğŸ“ æ™ºèƒ½æ‘˜è¦</h4>
                    <div style="background-color: #1e1e1e; padding: 15px; border-radius: 4px; border: 1px solid #3e3e42; margin: 10px 0;">
                        ${markdownToHtml(summary)}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="insertSummaryToNote()" style="margin-right: 10px;">æ’å…¥æ‘˜è¦</button>
                        <button class="btn btn-secondary" onclick="generateSummary()">é‡æ–°ç”Ÿæˆ</button>
                    </div>
                `;
                
                updateStatus('âœ… æ‘˜è¦ç”Ÿæˆå®Œæˆ');
                
            } catch (error) {
                console.error('ç”Ÿæˆæ‘˜è¦å¤±è´¥:', error);
                aiOutput.innerHTML = `
                    <h4>âŒ ç”Ÿæˆå¤±è´¥</h4>
                    <p style="color: #f48771;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    <button class="btn btn-secondary" onclick="generateSummary()" style="margin-top: 10px;">é‡è¯•</button>
                `;
                updateStatus('âŒ æ‘˜è¦ç”Ÿæˆå¤±è´¥');
            }
        }
        
        // ========== è¾…åŠ©å‡½æ•° ==========
        
        // ç®€å•çš„Markdownè½¬HTMLå‡½æ•°
        function markdownToHtml(markdown) {
            return markdown
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background-color: #2d2d30; padding: 2px 4px; border-radius: 3px;">$1</code>')
                .replace(/^### (.*$)/gim, '<h3 style="color: #4fc3f7; margin: 15px 0 10px 0;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="color: #4fc3f7; margin: 15px 0 10px 0;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="color: #4fc3f7; margin: 15px 0 10px 0;">$1</h1>')
                .replace(/^- (.*$)/gim, '<li style="margin: 5px 0;">$1</li>')
                .replace(/\n/g, '<br>');
        }
        
        // æ’å…¥è§„åˆ’åˆ°ä»Šæ—¥ç¬”è®°
        async function insertPlanToNote() {
            try {
                const settings = getCurrentSettings();
                if (!settings.knowledgeBasePath) {
                    alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®çŸ¥è¯†åº“è·¯å¾„');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                const todayNotePath = `${settings.knowledgeBasePath}/Daily Notes/${today}.md`;
                
                // è·å–AIè¾“å‡ºçš„å†…å®¹
                const aiOutput = document.getElementById('aiOutput');
                const planContent = aiOutput.querySelector('div[style*="background-color: #1e1e1e"]');
                if (!planContent) {
                    alert('æ²¡æœ‰æ‰¾åˆ°è§„åˆ’å†…å®¹');
                    return;
                }
                
                const planText = planContent.textContent;
                const insertContent = `\n\n## ğŸ“… AIç”Ÿæˆçš„ä»Šæ—¥è§„åˆ’\n\n${planText}\n`;
                
                // å°è¯•è¿½åŠ åˆ°ä»Šæ—¥ç¬”è®°
                const response = await fetch('/api/append-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        path: todayNotePath, 
                        content: insertContent 
                    })
                });
                
                if (response.ok) {
                    updateStatus('âœ… è§„åˆ’å·²æ’å…¥åˆ°ä»Šæ—¥ç¬”è®°');
                    alert('è§„åˆ’å·²æˆåŠŸæ’å…¥åˆ°ä»Šæ—¥ç¬”è®°ï¼');
                } else {
                    throw new Error('æ’å…¥å¤±è´¥');
                }
                
            } catch (error) {
                console.error('æ’å…¥è§„åˆ’å¤±è´¥:', error);
                alert('æ’å…¥è§„åˆ’å¤±è´¥: ' + error.message);
            }
        }
        
        // è¿½åŠ åˆ°å½“å‰ç¬”è®°
        async function appendToCurrentNote() {
            try {
                if (!currentFilePath) {
                    alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶');
                    return;
                }
                
                // è·å–AIè¾“å‡ºçš„å†…å®¹
                const aiOutput = document.getElementById('aiOutput');
                const analysisContent = aiOutput.querySelector('div[style*="background-color: #1e1e1e"]');
                if (!analysisContent) {
                    alert('æ²¡æœ‰æ‰¾åˆ°åˆ†æå†…å®¹');
                    return;
                }
                
                const analysisText = analysisContent.textContent;
                const insertContent = `\n\n## ğŸ’¡ AIæ€æƒ³æ•´åˆåˆ†æ\n\n${analysisText}\n`;
                
                // è¿½åŠ åˆ°å½“å‰æ–‡ä»¶
                const response = await fetch('/api/append-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        path: currentFilePath, 
                        content: insertContent 
                    })
                });
                
                if (response.ok) {
                    updateStatus('âœ… åˆ†æå·²è¿½åŠ åˆ°å½“å‰ç¬”è®°');
                    alert('åˆ†æå·²æˆåŠŸè¿½åŠ åˆ°å½“å‰ç¬”è®°ï¼');
                    // é‡æ–°åŠ è½½æ–‡ä»¶å†…å®¹
                    loadFile(currentFilePath);
                } else {
                    throw new Error('è¿½åŠ å¤±è´¥');
                }
                
            } catch (error) {
                console.error('è¿½åŠ åˆ†æå¤±è´¥:', error);
                alert('è¿½åŠ åˆ†æå¤±è´¥: ' + error.message);
            }
        }
        
        // æ’å…¥æ‘˜è¦åˆ°ç¬”è®°
        async function insertSummaryToNote() {
            try {
                if (!currentFilePath) {
                    alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶');
                    return;
                }
                
                // è·å–AIè¾“å‡ºçš„å†…å®¹
                const aiOutput = document.getElementById('aiOutput');
                const summaryContent = aiOutput.querySelector('div[style*="background-color: #1e1e1e"]');
                if (!summaryContent) {
                    alert('æ²¡æœ‰æ‰¾åˆ°æ‘˜è¦å†…å®¹');
                    return;
                }
                
                const summaryText = summaryContent.textContent;
                const insertContent = `\n\n## ğŸ“ AIç”Ÿæˆæ‘˜è¦\n\n${summaryText}\n`;
                
                // è¿½åŠ åˆ°å½“å‰æ–‡ä»¶
                const response = await fetch('/api/append-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        path: currentFilePath, 
                        content: insertContent 
                    })
                });
                
                if (response.ok) {
                    updateStatus('âœ… æ‘˜è¦å·²æ’å…¥åˆ°å½“å‰ç¬”è®°');
                    alert('æ‘˜è¦å·²æˆåŠŸæ’å…¥åˆ°å½“å‰ç¬”è®°ï¼');
                    // é‡æ–°åŠ è½½æ–‡ä»¶å†…å®¹
                    loadFile(currentFilePath);
                } else {
                    throw new Error('æ’å…¥å¤±è´¥');
                }
                
            } catch (error) {
                console.error('æ’å…¥æ‘˜è¦å¤±è´¥:', error);
                alert('æ’å…¥æ‘˜è¦å¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥å¼¹çª—
        function showNotification(message, type = 'info', duration = 4000) {
            console.log('showNotification called:', message, type);
            // ç§»é™¤å·²å­˜åœ¨çš„é€šçŸ¥
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // åˆ›å»ºæ–°é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
        
        // å…¨å±€å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„Ctrl+Så’ŒCtrl+P
            if (e.ctrlKey && (e.key === 's' || e.key === 'p')) {
                e.preventDefault();
            }
        });
        
        // å›è½¦é”®åŠ è½½è·¯å¾„
        document.getElementById('pathInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadPath();
            }
        });
        
        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            updateStatus('ğŸš€ æ­£åœ¨åˆå§‹åŒ– Monaco Editor...');
            initMonacoEditor();
            
            // è®¾ç½®é»˜è®¤æ–‡ä»¶å¤¹è·¯å¾„
            const defaultPath = 'D:\\iCloudDrive\\iCloud~md~obsidian\\OwenZ personal';
            document.getElementById('pathInput').value = defaultPath;
            
            // è‡ªåŠ¨åŠ è½½é»˜è®¤æ–‡ä»¶å¤¹
            setTimeout(() => {
                loadFileTree(defaultPath);
            }, 1000);
            
            updateStatus('âœ… åº”ç”¨å·²å¯åŠ¨ï¼Œæ­£åœ¨è‡ªåŠ¨åŠ è½½é»˜è®¤æ–‡ä»¶å¤¹...');
        });
        
        // ========== API æœåŠ¡æ¨¡å— ==========
        
        class AIApiService {
            constructor() {
                this.baseUrl = 'https://openrouter.ai/api/v1';
                this.defaultHeaders = {
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'AI Knowledge Base Assistant'
                };
            }
            
            // è·å–APIé…ç½®
            getApiConfig() {
                const settings = getCurrentSettings();
                if (!settings.openrouterApiKey) {
                    throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®OpenRouter API Key');
                }
                return {
                    apiKey: settings.openrouterApiKey,
                    model: settings.aiModel || 'anthropic/claude-3.5-sonnet'
                };
            }
            
            // å‘é€èŠå¤©è¯·æ±‚
            async sendChatRequest(messages, options = {}) {
                try {
                    const config = this.getApiConfig();
                    
                    const requestBody = {
                        model: config.model,
                        messages: messages,
                        max_tokens: options.maxTokens || 4000,
                        temperature: options.temperature || 0.7,
                        top_p: options.topP || 0.9,
                        stream: options.stream || false
                    };
                    
                    const response = await fetch(`${this.baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            ...this.defaultHeaders,
                            'Authorization': `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return data;
                    
                } catch (error) {
                    console.error('APIè¯·æ±‚é”™è¯¯:', error);
                    throw error;
                }
            }
            
            // ç”Ÿæˆæ¯æ—¥è§„åˆ’
            async generateDailyPlan(context = {}) {
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†ç®¡ç†å’Œæ—¶é—´è§„åˆ’åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„çŸ¥è¯†åº“å†…å®¹å’Œå½“å‰æƒ…å†µï¼Œç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„æ¯æ—¥è§„åˆ’ã€‚
                        
è§„åˆ’åº”è¯¥åŒ…æ‹¬ï¼š
1. ä»Šæ—¥é‡ç‚¹ä»»åŠ¡ï¼ˆ2-3ä¸ªï¼‰
2. å­¦ä¹ è®¡åˆ’
3. ç¬”è®°æ•´ç†å»ºè®®
4. æ—¶é—´åˆ†é…å»ºè®®

è¯·ç”¨Markdownæ ¼å¼è¾“å‡ºï¼Œå†…å®¹è¦å…·ä½“å¯æ‰§è¡Œã€‚`
                    },
                    {
                        role: 'user',
                        content: `è¯·ä¸ºæˆ‘ç”Ÿæˆä»Šæ—¥è§„åˆ’ã€‚

å½“å‰çŸ¥è¯†åº“è·¯å¾„: ${context.knowledgeBasePath || 'æœªè®¾ç½®'}
å½“å‰æ—¶é—´: ${new Date().toLocaleString('zh-CN')}

${context.additionalContext || ''}`
                    }
                ];
                
                return await this.sendChatRequest(messages);
            }
            
            // æ•´åˆæ€æƒ³ç¢ç‰‡
            async integrateThoughts(fragments, context = {}) {
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ€æƒ³æ•´åˆåŠ©æ‰‹ã€‚è¯·åˆ†æç”¨æˆ·æä¾›çš„æ€æƒ³ç¢ç‰‡ï¼Œæ‰¾å‡ºå…¶ä¸­çš„å…³è”æ€§å’Œä¸»é¢˜ï¼Œå¹¶æä¾›æ•´åˆå»ºè®®ã€‚
                        
åˆ†æåº”è¯¥åŒ…æ‹¬ï¼š
1. ä¸»è¦ä¸»é¢˜è¯†åˆ«
2. ç¢ç‰‡é—´çš„å…³è”æ€§
3. æ•´åˆå»ºè®®
4. åç»­è¡ŒåŠ¨å»ºè®®

è¯·ç”¨Markdownæ ¼å¼è¾“å‡ºã€‚`
                    },
                    {
                        role: 'user',
                        content: `è¯·å¸®æˆ‘æ•´åˆä»¥ä¸‹æ€æƒ³ç¢ç‰‡ï¼š

${fragments}

${context.additionalContext || ''}`
                    }
                ];
                
                return await this.sendChatRequest(messages);
            }
            
            // å†…å®¹åˆ†æ
            async analyzeContent(content, analysisType = 'general') {
                const systemPrompts = {
                    general: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹åˆ†æå¸ˆã€‚è¯·å¯¹æä¾›çš„å†…å®¹è¿›è¡Œå…¨é¢åˆ†æï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€ç»“æ„ã€å…³é”®ç‚¹å’Œæ”¹è¿›å»ºè®®ã€‚',
                    summary: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‘˜è¦ç”ŸæˆåŠ©æ‰‹ã€‚è¯·ä¸ºæä¾›çš„å†…å®¹ç”Ÿæˆç®€æ´è€Œå…¨é¢çš„æ‘˜è¦ã€‚',
                    keywords: 'ä½ æ˜¯ä¸€ä¸ªå…³é”®è¯æå–ä¸“å®¶ã€‚è¯·ä»æä¾›çš„å†…å®¹ä¸­æå–æœ€é‡è¦çš„å…³é”®è¯å’Œæ¦‚å¿µã€‚'
                };
                
                const messages = [
                    {
                        role: 'system',
                        content: systemPrompts[analysisType] || systemPrompts.general
                    },
                    {
                        role: 'user',
                        content: `è¯·åˆ†æä»¥ä¸‹å†…å®¹ï¼š

${content}`
                    }
                ];
                
                return await this.sendChatRequest(messages);
            }
            
            // æ£€æŸ¥APIè¿æ¥
            async testConnection() {
                try {
                    const config = this.getApiConfig();
                    
                    const response = await fetch(`${this.baseUrl}/models`, {
                        method: 'GET',
                        headers: {
                            ...this.defaultHeaders,
                            'Authorization': `Bearer ${config.apiKey}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`è¿æ¥æµ‹è¯•å¤±è´¥: ${response.status}`);
                    }
                    
                    return { success: true, message: 'APIè¿æ¥æ­£å¸¸' };
                    
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }
        }
        
        // åˆ›å»ºå…¨å±€APIæœåŠ¡å®ä¾‹
        const aiApiService = new AIApiService();
        
        // ========== æ•°æ®å®‰å…¨åŠŸèƒ½ ==========
        
        // ç®€å•çš„åŠ å¯†/è§£å¯†å‡½æ•°ï¼ˆåŸºäºBase64å’Œç®€å•å¼‚æˆ–ï¼‰
        class SimpleEncryption {
            constructor() {
                // ä½¿ç”¨è®¾å¤‡ç‰¹å¾ç”Ÿæˆå¯†é’¥
                this.key = this.generateDeviceKey();
            }
            
            generateDeviceKey() {
                const userAgent = navigator.userAgent;
                const screenInfo = `${screen.width}x${screen.height}`;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const combined = userAgent + screenInfo + timezone;
                
                // ç®€å•å“ˆå¸Œç”Ÿæˆå¯†é’¥
                let hash = 0;
                for (let i = 0; i < combined.length; i++) {
                    const char = combined.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
                }
                return Math.abs(hash).toString(36);
            }
            
            encrypt(text) {
                if (!text) return '';
                try {
                    const encoded = btoa(unescape(encodeURIComponent(text)));
                    let result = '';
                    for (let i = 0; i < encoded.length; i++) {
                        const keyChar = this.key.charCodeAt(i % this.key.length);
                        const encodedChar = encoded.charCodeAt(i);
                        result += String.fromCharCode(encodedChar ^ keyChar);
                    }
                    return btoa(result);
                } catch (error) {
                    console.error('åŠ å¯†å¤±è´¥:', error);
                    return text;
                }
            }
            
            decrypt(encryptedText) {
                if (!encryptedText) return '';
                try {
                    const encrypted = atob(encryptedText);
                    let result = '';
                    for (let i = 0; i < encrypted.length; i++) {
                        const keyChar = this.key.charCodeAt(i % this.key.length);
                        const encryptedChar = encrypted.charCodeAt(i);
                        result += String.fromCharCode(encryptedChar ^ keyChar);
                    }
                    return decodeURIComponent(escape(atob(result)));
                } catch (error) {
                    console.error('è§£å¯†å¤±è´¥:', error);
                    return encryptedText;
                }
            }
        }
        
        // åˆ›å»ºåŠ å¯†å®ä¾‹
        const encryption = new SimpleEncryption();
        
        // æ•°æ®å¤‡ä»½ç®¡ç†
        class BackupManager {
            constructor() {
                this.maxBackups = 10;
                this.backupKey = 'aiKnowledgeBaseBackups';
            }
            
            createBackup(data, type = 'settings') {
                try {
                    const backup = {
                        id: Date.now().toString(),
                        type: type,
                        data: data,
                        timestamp: new Date().toISOString(),
                        version: '1.0'
                    };
                    
                    const backups = this.getBackups();
                    backups.push(backup);
                    
                    // åªä¿ç•™æœ€è¿‘çš„å¤‡ä»½
                    if (backups.length > this.maxBackups) {
                        backups.splice(0, backups.length - this.maxBackups);
                    }
                    
                    localStorage.setItem(this.backupKey, JSON.stringify(backups));
                    console.log(`${type}å¤‡ä»½å·²åˆ›å»º:`, backup.id);
                    return backup.id;
                } catch (error) {
                    console.error('åˆ›å»ºå¤‡ä»½å¤±è´¥:', error);
                    return null;
                }
            }
            
            getBackups() {
                try {
                    return JSON.parse(localStorage.getItem(this.backupKey) || '[]');
                } catch (error) {
                    console.error('è·å–å¤‡ä»½å¤±è´¥:', error);
                    return [];
                }
            }
            
            restoreBackup(backupId) {
                try {
                    const backups = this.getBackups();
                    const backup = backups.find(b => b.id === backupId);
                    if (backup) {
                        return backup.data;
                    }
                    return null;
                } catch (error) {
                    console.error('æ¢å¤å¤‡ä»½å¤±è´¥:', error);
                    return null;
                }
            }
            
            deleteBackup(backupId) {
                try {
                    const backups = this.getBackups();
                    const filteredBackups = backups.filter(b => b.id !== backupId);
                    localStorage.setItem(this.backupKey, JSON.stringify(filteredBackups));
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤å¤‡ä»½å¤±è´¥:', error);
                    return false;
                }
            }
        }
        
        // åˆå§‹åŒ–å¤‡ä»½ç®¡ç†å™¨
        const backupManager = new BackupManager();
        
        // Promptæ¨¡æ¿ç®¡ç†ç±»
        class PromptTemplateManager {
            constructor() {
                this.storageKey = 'ai_prompt_templates';
                this.initDefaultTemplates();
            }
            
            // åˆå§‹åŒ–é»˜è®¤æ¨¡æ¿
            initDefaultTemplates() {
                const existing = this.getTemplates();
                if (existing.length === 0) {
                    this.resetToDefaults();
                }
            }
            
            // é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿
            resetToDefaults() {
                const defaultTemplates = [
                    {
                        id: 'summary_basic',
                        name: 'æ–‡æ¡£æ€»ç»“',
                        description: 'å¯¹æ–‡æ¡£å†…å®¹è¿›è¡Œç®€æ´çš„æ€»ç»“',
                        category: 'summary',
                        content: 'è¯·å¯¹ä»¥ä¸‹æ–‡æ¡£å†…å®¹è¿›è¡Œæ€»ç»“ï¼Œæå–å…³é”®ä¿¡æ¯å’Œè¦ç‚¹ï¼š\n\næ–‡æ¡£åç§°ï¼š{filename}\næ–‡æ¡£å†…å®¹ï¼š\n{content}\n\nè¯·æä¾›ï¼š\n1. ä¸»è¦å†…å®¹æ¦‚è¿°\n2. å…³é”®è¦ç‚¹ï¼ˆ3-5ä¸ªï¼‰\n3. ç»“è®ºæˆ–å»ºè®®'
                    },
                    {
                        id: 'analysis_deep',
                        name: 'æ·±åº¦åˆ†æ',
                        description: 'å¯¹æ–‡æ¡£è¿›è¡Œæ·±å…¥çš„åˆ†æå’Œè§£è¯»',
                        category: 'analysis',
                        content: 'è¯·å¯¹ä»¥ä¸‹æ–‡æ¡£è¿›è¡Œæ·±åº¦åˆ†æï¼š\n\næ–‡æ¡£åç§°ï¼š{filename}\næ–‡æ¡£å†…å®¹ï¼š\n{content}\n\nè¯·ä»ä»¥ä¸‹è§’åº¦è¿›è¡Œåˆ†æï¼š\n1. å†…å®¹ç»“æ„å’Œé€»è¾‘\n2. å…³é”®æ¦‚å¿µå’Œæœ¯è¯­\n3. æ½œåœ¨é—®é¢˜æˆ–æ”¹è¿›ç‚¹\n4. ç›¸å…³æ€§å’Œå®ç”¨æ€§è¯„ä¼°'
                    },
                    {
                        id: 'planning_action',
                        name: 'è¡ŒåŠ¨è§„åˆ’',
                        description: 'åŸºäºæ–‡æ¡£å†…å®¹åˆ¶å®šè¡ŒåŠ¨è®¡åˆ’',
                        category: 'planning',
                        content: 'åŸºäºä»¥ä¸‹æ–‡æ¡£å†…å®¹ï¼Œè¯·åˆ¶å®šè¯¦ç»†çš„è¡ŒåŠ¨è§„åˆ’ï¼š\n\næ–‡æ¡£åç§°ï¼š{filename}\næ–‡æ¡£å†…å®¹ï¼š\n{content}\n\nè¯·æä¾›ï¼š\n1. ç›®æ ‡è®¾å®š\n2. å…·ä½“è¡ŒåŠ¨æ­¥éª¤\n3. æ—¶é—´å®‰æ’å»ºè®®\n4. èµ„æºéœ€æ±‚\n5. é£é™©è¯„ä¼°å’Œåº”å¯¹æªæ–½'
                    },
                    {
                        id: 'writing_improve',
                        name: 'å†™ä½œæ”¹è¿›',
                        description: 'æ”¹è¿›æ–‡æ¡£çš„å†™ä½œè´¨é‡å’Œè¡¨è¾¾',
                        category: 'writing',
                        content: 'è¯·å¸®åŠ©æ”¹è¿›ä»¥ä¸‹æ–‡æ¡£çš„å†™ä½œè´¨é‡ï¼š\n\næ–‡æ¡£åç§°ï¼š{filename}\nåŸå§‹å†…å®¹ï¼š\n{content}\n\nè¯·æä¾›ï¼š\n1. è¯­è¨€è¡¨è¾¾çš„æ”¹è¿›å»ºè®®\n2. ç»“æ„ä¼˜åŒ–å»ºè®®\n3. å†…å®¹è¡¥å……å»ºè®®\n4. ä¿®æ”¹åçš„ç‰ˆæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰'
                    }
                ];
                
                localStorage.setItem(this.storageKey, JSON.stringify(defaultTemplates));
            }
            
            // è·å–æ‰€æœ‰æ¨¡æ¿
            getTemplates() {
                const stored = localStorage.getItem(this.storageKey);
                return stored ? JSON.parse(stored) : [];
            }
            
            // ä¿å­˜æ¨¡æ¿
            saveTemplate(template) {
                const templates = this.getTemplates();
                const existingIndex = templates.findIndex(t => t.id === template.id);
                
                if (existingIndex >= 0) {
                    templates[existingIndex] = template;
                } else {
                    template.id = 'custom_' + Date.now();
                    templates.push(template);
                }
                
                localStorage.setItem(this.storageKey, JSON.stringify(templates));
                return template;
            }
            
            // åˆ é™¤æ¨¡æ¿
            deleteTemplate(templateId) {
                const templates = this.getTemplates();
                const filtered = templates.filter(t => t.id !== templateId);
                localStorage.setItem(this.storageKey, JSON.stringify(filtered));
            }
            
            // è·å–å•ä¸ªæ¨¡æ¿
            getTemplate(templateId) {
                const templates = this.getTemplates();
                return templates.find(t => t.id === templateId);
            }
            
            // åº”ç”¨æ¨¡æ¿å˜é‡æ›¿æ¢
            applyTemplate(templateId, variables = {}) {
                const template = this.getTemplate(templateId);
                if (!template) return null;
                
                let content = template.content;
                
                // æ›¿æ¢å˜é‡
                Object.keys(variables).forEach(key => {
                    const placeholder = `{${key}}`;
                    content = content.replace(new RegExp(placeholder, 'g'), variables[key] || '');
                });
                
                return {
                    ...template,
                    processedContent: content
                };
            }
        }
        
        // åˆå§‹åŒ–Promptæ¨¡æ¿ç®¡ç†å™¨
        const promptManager = new PromptTemplateManager();
        let currentEditingTemplate = null;
        
        // ========== è®¾ç½®åŠŸèƒ½ ==========
        
        // æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'block';
            loadSettings();
            switchTab('basic'); // é»˜è®¤æ˜¾ç¤ºåŸºæœ¬è®¾ç½®
        }
        
        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰é€‰é¡¹å¡å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰é€‰é¡¹å¡æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„é€‰é¡¹å¡
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // æ¿€æ´»å¯¹åº”çš„é€‰é¡¹å¡æŒ‰é’®
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°å¤‡ä»½é€‰é¡¹å¡ï¼Œåˆ·æ–°å¤‡ä»½åˆ—è¡¨
             if (tabName === 'backup') {
                 refreshBackupList();
             }
             
             // å¦‚æœåˆ‡æ¢åˆ°Prompté€‰é¡¹å¡ï¼Œåˆ·æ–°æ¨¡æ¿åˆ—è¡¨
             if (tabName === 'prompt') {
                 refreshPromptTemplateList();
             }
         }
         
         // åˆ›å»ºæ‰‹åŠ¨å¤‡ä»½
         function createManualBackup() {
             try {
                 const settings = getCurrentSettings();
                 backupManager.createBackup(settings, 'manual');
                 updateStatus('æ‰‹åŠ¨å¤‡ä»½åˆ›å»ºæˆåŠŸ', 'success');
                 refreshBackupList();
             } catch (error) {
                 console.error('åˆ›å»ºå¤‡ä»½å¤±è´¥:', error);
                 updateStatus('åˆ›å»ºå¤‡ä»½å¤±è´¥: ' + error.message, 'error');
             }
         }
         
         // åˆ·æ–°å¤‡ä»½åˆ—è¡¨
         function refreshBackupList() {
             const backupList = document.getElementById('backupList');
             const backups = backupManager.getBackups();
             
             if (backups.length === 0) {
                 backupList.innerHTML = '<p style="color: #888888; text-align: center; padding: 20px;">æš‚æ— å¤‡ä»½</p>';
                 return;
             }
             
             backupList.innerHTML = backups.map(backup => {
                 const date = new Date(backup.timestamp);
                 const timeStr = date.toLocaleString('zh-CN');
                 const typeText = backup.type === 'auto' ? 'è‡ªåŠ¨å¤‡ä»½' : 'æ‰‹åŠ¨å¤‡ä»½';
                 
                 return `
                     <div class="backup-item">
                         <div>
                             <div class="backup-info-text">${typeText}</div>
                             <div class="backup-time">${timeStr}</div>
                         </div>
                         <div class="backup-actions-btn">
                             <button class="btn btn-small" onclick="restoreBackup('${backup.id}')" title="æ¢å¤æ­¤å¤‡ä»½">
                                 æ¢å¤
                             </button>
                             <button class="btn btn-small" onclick="deleteBackup('${backup.id}')" title="åˆ é™¤æ­¤å¤‡ä»½" style="background-color: #d73a49;">
                                 åˆ é™¤
                             </button>
                         </div>
                     </div>
                 `;
             }).join('');
         }
         
         // æ¢å¤å¤‡ä»½
         function restoreBackup(backupId) {
             if (!confirm('ç¡®å®šè¦æ¢å¤æ­¤å¤‡ä»½å—ï¼Ÿå½“å‰è®¾ç½®å°†è¢«è¦†ç›–ã€‚')) {
                 return;
             }
             
             try {
                 const backup = backupManager.restoreBackup(backupId);
                 if (backup) {
                     // é‡æ–°åŠ è½½è®¾ç½®åˆ°ç•Œé¢
                     loadSettings();
                     updateStatus('å¤‡ä»½æ¢å¤æˆåŠŸ', 'success');
                 } else {
                     updateStatus('å¤‡ä»½æ¢å¤å¤±è´¥ï¼šå¤‡ä»½ä¸å­˜åœ¨', 'error');
                 }
             } catch (error) {
                 console.error('æ¢å¤å¤‡ä»½å¤±è´¥:', error);
                 updateStatus('æ¢å¤å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
             }
         }
         
         // åˆ é™¤å¤‡ä»½
         function deleteBackup(backupId) {
             if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¤‡ä»½å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                 return;
             }
             
             try {
                 backupManager.deleteBackup(backupId);
                 updateStatus('å¤‡ä»½åˆ é™¤æˆåŠŸ', 'success');
                 refreshBackupList();
             } catch (error) {
                 console.error('åˆ é™¤å¤‡ä»½å¤±è´¥:', error);
                 updateStatus('åˆ é™¤å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
              }
          }
          
          // ========== Promptæ¨¡æ¿ç®¡ç†åŠŸèƒ½ ==========
          
          // åˆ·æ–°Promptæ¨¡æ¿åˆ—è¡¨
          function refreshPromptTemplateList() {
              const templateList = document.getElementById('promptTemplateList');
              const templates = promptManager.getTemplates();
              
              if (templates.length === 0) {
                  templateList.innerHTML = '<p style="color: #888888; text-align: center; padding: 20px;">æš‚æ— æ¨¡æ¿ï¼Œç‚¹å‡»"æ·»åŠ æ¨¡æ¿"åˆ›å»ºç¬¬ä¸€ä¸ªæ¨¡æ¿</p>';
                  return;
              }
              
              templateList.innerHTML = templates.map(template => {
                  const categoryColors = {
                      summary: '#28a745',
                      analysis: '#007acc',
                      planning: '#ffc107',
                      writing: '#dc3545',
                      custom: '#6c757d'
                  };
                  
                  const categoryColor = categoryColors[template.category] || '#6c757d';
                  const previewContent = template.content.length > 100 
                      ? template.content.substring(0, 100) + '...' 
                      : template.content;
                  
                  return `
                      <div class="prompt-item">
                          <div class="prompt-header">
                              <h5 class="prompt-title">${template.name}</h5>
                              <span class="prompt-category" style="background-color: ${categoryColor}">${getCategoryName(template.category)}</span>
                          </div>
                          <div class="prompt-description">${template.description}</div>
                          <div class="prompt-content-preview">${previewContent}</div>
                          <div class="prompt-actions-btn">
                              <button class="btn btn-small" onclick="usePromptTemplate('${template.id}')" title="ä½¿ç”¨æ­¤æ¨¡æ¿">
                                  ğŸš€ ä½¿ç”¨
                              </button>
                              <button class="btn btn-small" onclick="editPromptTemplate('${template.id}')" title="ç¼–è¾‘æ¨¡æ¿">
                                  âœï¸ ç¼–è¾‘
                              </button>
                              <button class="btn btn-small" onclick="deletePromptTemplate('${template.id}')" title="åˆ é™¤æ¨¡æ¿" style="background-color: #d73a49;">
                                  ğŸ—‘ï¸ åˆ é™¤
                              </button>
                          </div>
                      </div>
                  `;
              }).join('');
          }
          
          // è·å–åˆ†ç±»åç§°
          function getCategoryName(category) {
              const names = {
                  summary: 'æ€»ç»“',
                  analysis: 'åˆ†æ',
                  planning: 'è§„åˆ’',
                  writing: 'å†™ä½œ',
                  custom: 'è‡ªå®šä¹‰'
              };
              return names[category] || 'è‡ªå®šä¹‰';
          }
          
          // æ·»åŠ æ–°æ¨¡æ¿
          function addPromptTemplate() {
              currentEditingTemplate = null;
              document.getElementById('promptName').value = '';
              document.getElementById('promptDescription').value = '';
              document.getElementById('promptContent').value = '';
              document.getElementById('promptCategory').value = 'custom';
              document.getElementById('promptEditModal').style.display = 'block';
          }
          
          // ç¼–è¾‘æ¨¡æ¿
          function editPromptTemplate(templateId) {
              const template = promptManager.getTemplate(templateId);
              if (!template) return;
              
              currentEditingTemplate = template;
              document.getElementById('promptName').value = template.name;
              document.getElementById('promptDescription').value = template.description;
              document.getElementById('promptContent').value = template.content;
              document.getElementById('promptCategory').value = template.category;
              document.getElementById('promptEditModal').style.display = 'block';
          }
          
          // ä¿å­˜æ¨¡æ¿
          function savePromptTemplate() {
              const name = document.getElementById('promptName').value.trim();
              const description = document.getElementById('promptDescription').value.trim();
              const content = document.getElementById('promptContent').value.trim();
              const category = document.getElementById('promptCategory').value;
              
              if (!name) {
                  updateStatus('è¯·è¾“å…¥æ¨¡æ¿åç§°', 'error');
                  return;
              }
              
              if (!content) {
                  updateStatus('è¯·è¾“å…¥Promptå†…å®¹', 'error');
                  return;
              }
              
              const template = {
                  id: currentEditingTemplate ? currentEditingTemplate.id : undefined,
                  name,
                  description,
                  content,
                  category
              };
              
              try {
                  promptManager.saveTemplate(template);
                  updateStatus('æ¨¡æ¿ä¿å­˜æˆåŠŸ', 'success');
                  closePromptEditModal();
                  refreshPromptTemplateList();
              } catch (error) {
                  console.error('ä¿å­˜æ¨¡æ¿å¤±è´¥:', error);
                  updateStatus('ä¿å­˜æ¨¡æ¿å¤±è´¥: ' + error.message, 'error');
              }
          }
          
          // åˆ é™¤æ¨¡æ¿
          function deletePromptTemplate(templateId) {
              if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¨¡æ¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                  return;
              }
              
              try {
                  promptManager.deleteTemplate(templateId);
                  updateStatus('æ¨¡æ¿åˆ é™¤æˆåŠŸ', 'success');
                  refreshPromptTemplateList();
              } catch (error) {
                  console.error('åˆ é™¤æ¨¡æ¿å¤±è´¥:', error);
                  updateStatus('åˆ é™¤æ¨¡æ¿å¤±è´¥: ' + error.message, 'error');
              }
          }
          
          // é‡ç½®é»˜è®¤æ¨¡æ¿
          function resetDefaultTemplates() {
              if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰æ¨¡æ¿ã€‚')) {
                  return;
              }
              
              try {
                  promptManager.resetToDefaults();
                  updateStatus('å·²é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿', 'success');
                  refreshPromptTemplateList();
              } catch (error) {
                  console.error('é‡ç½®æ¨¡æ¿å¤±è´¥:', error);
                  updateStatus('é‡ç½®æ¨¡æ¿å¤±è´¥: ' + error.message, 'error');
              }
          }
          
          // ä½¿ç”¨æ¨¡æ¿
          function usePromptTemplate(templateId) {
              const template = promptManager.getTemplate(templateId);
              if (!template) {
                  updateStatus('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
                  return;
              }
              
              // è·å–å½“å‰ä¸Šä¸‹æ–‡
              const variables = {
                  filename: currentFilePath ? currentFilePath.split('/').pop() : 'æœªé€‰æ‹©æ–‡ä»¶',
                  content: monacoEditor ? monacoEditor.getValue() : '',
                  selection: monacoEditor ? monacoEditor.getModel().getValueInRange(monacoEditor.getSelection()) : ''
              };
              
              const processedTemplate = promptManager.applyTemplate(templateId, variables);
              
              // å°†å¤„ç†åçš„å†…å®¹è®¾ç½®åˆ°AIè¾“å…¥æ¡†
              const aiInput = document.getElementById('aiInput');
              if (aiInput) {
                  aiInput.value = processedTemplate.processedContent;
                  updateStatus(`å·²åº”ç”¨æ¨¡æ¿: ${template.name}`, 'success');
                  
                  // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
                  closeSettings();
                  
                  // èšç„¦åˆ°AIè¾“å…¥æ¡†
                  aiInput.focus();
              } else {
                  updateStatus('AIè¾“å…¥æ¡†æœªæ‰¾åˆ°', 'error');
              }
          }
          
          // å…³é—­æ¨¡æ¿ç¼–è¾‘æ¨¡æ€æ¡†
           function closePromptEditModal() {
               document.getElementById('promptEditModal').style.display = 'none';
               currentEditingTemplate = null;
           }
           
           // åˆå§‹åŒ–å¿«é€Ÿæ¨¡æ¿é€‰æ‹©å™¨
           function initQuickPromptSelect() {
               const select = document.getElementById('quickPromptSelect');
               if (!select) return;
               
               const templates = promptManager.getTemplates();
               
               // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
               select.innerHTML = '<option value="">é€‰æ‹©Promptæ¨¡æ¿...</option>';
               
               // æ·»åŠ æ¨¡æ¿é€‰é¡¹
               templates.forEach(template => {
                   const option = document.createElement('option');
                   option.value = template.id;
                   option.textContent = `${getCategoryName(template.category)} - ${template.name}`;
                   select.appendChild(option);
               });
           }
           
           // åº”ç”¨å¿«é€Ÿæ¨¡æ¿
           function applyQuickPrompt() {
               const select = document.getElementById('quickPromptSelect');
               const templateId = select.value;
               
               if (!templateId) return;
               
               const template = promptManager.getTemplate(templateId);
               if (!template) {
                   updateStatus('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
                   return;
               }
               
               // è·å–å½“å‰ä¸Šä¸‹æ–‡
               const variables = {
                   filename: currentFilePath ? currentFilePath.split('/').pop() : 'æœªé€‰æ‹©æ–‡ä»¶',
                   content: monacoEditor ? monacoEditor.getValue() : '',
                   selection: monacoEditor ? monacoEditor.getModel().getValueInRange(monacoEditor.getSelection()) : ''
               };
               
               const processedTemplate = promptManager.applyTemplate(templateId, variables);
               
               // å°†å¤„ç†åçš„å†…å®¹è®¾ç½®åˆ°AIè¾“å…¥æ¡†
               const aiInput = document.getElementById('aiInput');
               if (aiInput) {
                   aiInput.value = processedTemplate.processedContent;
                   updateStatus(`å·²åº”ç”¨æ¨¡æ¿: ${template.name}`, 'success');
                   
                   // é‡ç½®é€‰æ‹©å™¨
                   select.value = '';
                   
                   // èšç„¦åˆ°AIè¾“å…¥æ¡†
                   aiInput.focus();
               }
           }
           
           // å‘é€åˆ°AI
           async function sendToAI() {
               const aiInput = document.getElementById('aiInput');
               const aiOutput = document.getElementById('aiOutput');
               
               if (!aiInput || !aiOutput) {
                   updateStatus('AIç•Œé¢å…ƒç´ æœªæ‰¾åˆ°', 'error');
                   return;
               }
               
               const inputText = aiInput.value.trim();
               if (!inputText) {
                   updateStatus('è¯·è¾“å…¥é—®é¢˜æˆ–é€‰æ‹©æ¨¡æ¿', 'error');
                   return;
               }
               
               // æ£€æŸ¥è®¾ç½®
               const settings = getCurrentSettings();
               if (!settings.openrouterApiKey) {
                   updateStatus('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®OpenRouter API Key', 'error');
                   return;
               }
               
               try {
                   // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                   aiOutput.innerHTML = '<div style="text-align: center; color: #007acc; padding: 20px;">ğŸ¤– AIæ­£åœ¨æ€è€ƒä¸­...</div>';
                   updateStatus('æ­£åœ¨å‘é€è¯·æ±‚åˆ°AI...', 'info');
                   
                   // å‘é€è¯·æ±‚åˆ°AI
                   const response = await aiApiService.sendMessage(inputText);
                   
                   // æ˜¾ç¤ºAIå›å¤
                   aiOutput.innerHTML = `
                       <div style="background-color: #2d2d30; border: 1px solid #464647; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                           <div style="color: #007acc; font-weight: bold; margin-bottom: 8px;">ğŸ¤– AIå›å¤ï¼š</div>
                           <div style="color: #cccccc; line-height: 1.6; white-space: pre-wrap;">${response}</div>
                       </div>
                       <div style="text-align: center; margin-top: 10px;">
                           <button class="btn btn-small" onclick="insertAIResponseToNote('${response.replace(/'/g, "\\'")}')">ğŸ“ æ’å…¥åˆ°ç¬”è®°</button>
                           <button class="btn btn-small" onclick="clearAIConversation()">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
                       </div>
                   `;
                   
                   updateStatus('AIå›å¤å®Œæˆ', 'success');
                   
                   // æ¸…ç©ºè¾“å…¥æ¡†
                   aiInput.value = '';
                   
               } catch (error) {
                   console.error('AIè¯·æ±‚å¤±è´¥:', error);
                   aiOutput.innerHTML = `
                       <div style="background-color: #d73a49; border: 1px solid #dc3545; border-radius: 6px; padding: 15px; color: #ffffff;">
                           <div style="font-weight: bold; margin-bottom: 8px;">âŒ è¯·æ±‚å¤±è´¥</div>
                           <div>${error.message}</div>
                       </div>
                   `;
                   updateStatus('AIè¯·æ±‚å¤±è´¥: ' + error.message, 'error');
               }
           }
           
           // æ’å…¥AIå›å¤åˆ°ç¬”è®°
           function insertAIResponseToNote(response) {
               if (!currentFilePath) {
                   updateStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                   return;
               }
               
               if (!monacoEditor) {
                   updateStatus('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                   return;
               }
               
               // åœ¨å½“å‰å…‰æ ‡ä½ç½®æ’å…¥AIå›å¤
               const position = monacoEditor.getPosition();
               const text = `\n\n## AIå›å¤\n\n${response}\n\n`;
               
               monacoEditor.executeEdits('insert-ai-response', [{
                   range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
                   text: text
               }]);
               
               updateStatus('AIå›å¤å·²æ’å…¥åˆ°ç¬”è®°', 'success');
           }
           
           // æ¸…ç©ºAIå¯¹è¯
           function clearAIConversation() {
               const aiOutput = document.getElementById('aiOutput');
               const aiInput = document.getElementById('aiInput');
               
               if (aiOutput) {
                   aiOutput.innerHTML = '<p style="color: #a0a0a0; text-align: center; margin-top: 50px;">ğŸ¤– AIåŠ©æ‰‹å·²å°±ç»ª<br><br>é€‰æ‹©æ¨¡æ¿æˆ–è¾“å…¥é—®é¢˜å¼€å§‹å¯¹è¯</p>';
               }
               
               if (aiInput) {
                   aiInput.value = '';
               }
               
               updateStatus('å¯¹è¯å·²æ¸…ç©º', 'success');
           }
           

           
           // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
           async function refreshModelList() {
               const apiKeyInput = document.getElementById('openrouterApiKey');
               const modelSelect = document.getElementById('aiModel');
               const refreshBtn = document.getElementById('refreshModels');
               
               const apiKey = apiKeyInput.value.trim();
               if (!apiKey) {
                   updateStatus('è¯·å…ˆè¾“å…¥å¹¶æ ¡éªŒAPIå¯†é’¥', 'error');
                   showNotification('è¯·å…ˆè¾“å…¥å¹¶æ ¡éªŒAPIå¯†é’¥', 'warning');
                   return;
               }
               
               // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
               refreshBtn.disabled = true;
               refreshBtn.innerHTML = '<span class="loading-spinner">â—</span> åŠ è½½ä¸­...';
               updateStatus('æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...', 'info');
               
               try {
                   const response = await fetch('https://openrouter.ai/api/v1/models', {
                       method: 'GET',
                       headers: {
                           'Authorization': `Bearer ${apiKey}`,
                           'Content-Type': 'application/json'
                       }
                   });
                   
                   if (response.ok) {
                       const data = await response.json();
                       const models = data.data || [];
                       
                       // ä¿å­˜å½“å‰é€‰ä¸­çš„æ¨¡å‹
                       const currentModel = modelSelect.value;
                       
                       // æ¸…ç©ºç°æœ‰é€‰é¡¹
                       modelSelect.innerHTML = '';
                       
                       // æŒ‰æä¾›å•†åˆ†ç»„æ¨¡å‹
                       const modelsByProvider = {};
                       models.forEach(model => {
                           const provider = model.id.split('/')[0];
                           if (!modelsByProvider[provider]) {
                               modelsByProvider[provider] = [];
                           }
                           modelsByProvider[provider].push(model);
                       });
                       
                       // æ·»åŠ æ¨èæ¨¡å‹
                       const recommendedModels = [
                           'anthropic/claude-3.5-sonnet',
                           'openai/gpt-4o',
                           'openai/gpt-4o-mini',
                           'google/gemini-pro-1.5'
                       ];
                       
                       // æ·»åŠ æ¨èæ¨¡å‹ç»„
                       const recommendedGroup = document.createElement('optgroup');
                       recommendedGroup.label = 'æ¨èæ¨¡å‹';
                       modelSelect.appendChild(recommendedGroup);
                       
                       recommendedModels.forEach(modelId => {
                           const model = models.find(m => m.id === modelId);
                           if (model) {
                               const option = document.createElement('option');
                               option.value = model.id;
                               option.textContent = `${model.name || model.id} ${modelId === 'anthropic/claude-3.5-sonnet' ? '(æ¨è)' : ''}`;
                               recommendedGroup.appendChild(option);
                           }
                       });
                       
                       // æ·»åŠ å…¶ä»–æ¨¡å‹ç»„
                       Object.keys(modelsByProvider).sort().forEach(provider => {
                           const providerModels = modelsByProvider[provider];
                           if (providerModels.length === 0) return;
                           
                           const group = document.createElement('optgroup');
                           group.label = provider.charAt(0).toUpperCase() + provider.slice(1);
                           
                           providerModels
                               .filter(model => !recommendedModels.includes(model.id))
                               .sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id))
                               .forEach(model => {
                                   const option = document.createElement('option');
                                   option.value = model.id;
                                   option.textContent = model.name || model.id;
                                   group.appendChild(option);
                               });
                           
                           if (group.children.length > 0) {
                               modelSelect.appendChild(group);
                           }
                       });
                       
                       // æ¢å¤ä¹‹å‰é€‰ä¸­çš„æ¨¡å‹
                       if (currentModel) {
                           modelSelect.value = currentModel;
                       }
                       
                       updateStatus(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹`, 'success');
                       showNotification(`æˆåŠŸè·å– ${models.length} ä¸ªå¯ç”¨æ¨¡å‹`, 'success');
                   } else {
                       const errorData = await response.json().catch(() => ({}));
                       const errorMsg = errorData.error?.message || response.statusText;
                       updateStatus(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${errorMsg}`, 'error');
                       showNotification(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${errorMsg}`, 'error');
                   }
               } catch (error) {
                   console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                   const errorMsg = error.message || 'ç½‘ç»œè¿æ¥å¤±è´¥';
                   updateStatus('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + errorMsg, 'error');
                   showNotification(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${errorMsg}ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•`, 'error');
               } finally {
                   refreshBtn.disabled = false;
                   refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°';
               }
           }
        
        // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'none';
        }
        
        // åŠ è½½è®¾ç½®
        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('aiKnowledgeBaseSettings') || '{}');
                
                document.getElementById('knowledgeBasePath').value = settings.knowledgeBasePath || '';
                // è§£å¯†API Key
                const decryptedApiKey = settings.openrouterApiKey ? encryption.decrypt(settings.openrouterApiKey) : '';
                document.getElementById('openrouterApiKey').value = decryptedApiKey;
                document.getElementById('aiModel').value = settings.aiModel || 'anthropic/claude-3.5-sonnet';
                document.getElementById('autoBackup').value = settings.autoBackup || 'true';
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                updateStatus('âš ï¸ åŠ è½½è®¾ç½®å¤±è´¥');
            }
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            try {
                const rawApiKey = document.getElementById('openrouterApiKey').value.trim();
                const settings = {
                    knowledgeBasePath: document.getElementById('knowledgeBasePath').value.trim(),
                    openrouterApiKey: rawApiKey ? encryption.encrypt(rawApiKey) : '', // åŠ å¯†API Key
                    aiModel: document.getElementById('aiModel').value,
                    autoBackup: document.getElementById('autoBackup').value,
                    lastUpdated: new Date().toISOString()
                };
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!settings.knowledgeBasePath) {
                    alert('è¯·è¾“å…¥çŸ¥è¯†åº“è·¯å¾„');
                    return;
                }
                
                if (!rawApiKey) {
                    alert('è¯·è¾“å…¥OpenRouter API Key');
                    return;
                }
                
                // éªŒè¯API Keyæ ¼å¼
                if (!rawApiKey.startsWith('sk-or-v1-')) {
                    alert('API Keyæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä»¥"sk-or-v1-"å¼€å¤´');
                    return;
                }
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('aiKnowledgeBaseSettings', JSON.stringify(settings));
                
                // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨å¤‡ä»½ï¼Œåˆ›å»ºå¤‡ä»½
                if (settings.autoBackup === 'true') {
                    backupManager.createBackup(settings, 'settings');
                }
                
                updateStatus('âœ… è®¾ç½®å·²ä¿å­˜');
                closeSettings();
                
                // å¦‚æœçŸ¥è¯†åº“è·¯å¾„å‘ç”Ÿå˜åŒ–ï¼Œè‡ªåŠ¨åŠ è½½æ–°è·¯å¾„
                if (settings.knowledgeBasePath !== currentFolderPath) {
                    document.getElementById('pathInput').value = settings.knowledgeBasePath;
                    loadPath();
                }
                
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                updateStatus('âŒ ä¿å­˜è®¾ç½®å¤±è´¥');
                alert('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        
        // è·å–å½“å‰è®¾ç½®
        function getCurrentSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('aiKnowledgeBaseSettings') || '{}');
                // è§£å¯†API Keyç”¨äºå®é™…ä½¿ç”¨
                if (settings.openrouterApiKey) {
                    settings.openrouterApiKey = encryption.decrypt(settings.openrouterApiKey);
                }
                return settings;
            } catch (error) {
                console.error('è·å–è®¾ç½®å¤±è´¥:', error);
                return {};
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettings();
            }
        }
        
        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('settingsModal');
                if (modal.style.display === 'block') {
                    closeSettings();
                }
            }
        });
        
        // ========== é¢æ¿Tabåˆ‡æ¢åŠŸèƒ½ ==========
        
        // åˆ‡æ¢é¢æ¿Tab
        function switchPanelTab(tabName) {
            // ç§»é™¤æ‰€æœ‰TabæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // éšè—æ‰€æœ‰é¢æ¿å†…å®¹
            document.querySelectorAll('.panel-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æ¿€æ´»é€‰ä¸­çš„Tab
            event.target.classList.add('active');
            
            // æ˜¾ç¤ºå¯¹åº”çš„é¢æ¿å†…å®¹
            const targetPanel = document.getElementById(tabName + 'Panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            updateStatus(`å·²åˆ‡æ¢åˆ°${tabName === 'ai' ? 'AIåŠ©æ‰‹' : 'ç•ªèŒ„é’Ÿ'}é¢æ¿`);
        }
        
        // ========== ç•ªèŒ„é’ŸåŠŸèƒ½ ==========
        
        let timerInterval = null;
        let totalSeconds = 25 * 60; // é»˜è®¤25åˆ†é’Ÿ
        let remainingSeconds = totalSeconds;
        let isTimerRunning = false;
        let timerStats = {
            completedPomodoros: 0,
            focusTime: 0,
            breakTime: 0
        };
        
        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            const status = document.getElementById('timerStatus');
            
            if (display) {
                display.textContent = formatTime(remainingSeconds);
                
                // æ—¶é—´ç´§è¿«æ—¶æ”¹å˜é¢œè‰²
                if (remainingSeconds <= 300 && isTimerRunning) { // æœ€å5åˆ†é’Ÿ
                    display.style.color = '#f39c12';
                } else if (remainingSeconds <= 60 && isTimerRunning) { // æœ€å1åˆ†é’Ÿ
                    display.style.color = '#e74c3c';
                } else {
                    display.style.color = '#4fc3f7';
                }
            }
            
            if (status) {
                if (isTimerRunning) {
                    status.textContent = 'æ­£åœ¨ä¸“æ³¨å·¥ä½œä¸­...';
                } else if (remainingSeconds === 0) {
                    status.textContent = 'æ—¶é—´åˆ°ï¼è¯¥ä¼‘æ¯ä¸€ä¸‹äº†';
                } else {
                    status.textContent = 'å‡†å¤‡å¼€å§‹å·¥ä½œ';
                }
            }
        }
        
        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            if (isTimerRunning) return;
            
            isTimerRunning = true;
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) {
                startBtn.style.display = 'none';
            }
            if (pauseBtn) {
                pauseBtn.style.display = 'inline-flex';
            }
            
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay();
                
                if (remainingSeconds <= 0) {
                    timerComplete();
                }
            }, 1000);
            
            updateStatus('ğŸ… ç•ªèŒ„é’Ÿå·²å¼€å§‹');
            updateTimerDisplay();
        }
        
        // æš‚åœè®¡æ—¶å™¨
        function pauseTimer() {
            if (!isTimerRunning) return;
            
            isTimerRunning = false;
            clearInterval(timerInterval);
            
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) {
                startBtn.style.display = 'inline-flex';
                startBtn.innerHTML = 'â–¶ï¸ ç»§ç»­';
            }
            if (pauseBtn) {
                pauseBtn.style.display = 'none';
            }
            
            updateStatus('â¸ï¸ ç•ªèŒ„é’Ÿå·²æš‚åœ');
            updateTimerDisplay();
        }
        
        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            isTimerRunning = false;
            clearInterval(timerInterval);
            remainingSeconds = totalSeconds;
            
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) {
                startBtn.style.display = 'inline-flex';
                startBtn.innerHTML = 'â–¶ï¸ å¼€å§‹';
            }
            if (pauseBtn) {
                pauseBtn.style.display = 'none';
            }
            
            updateStatus('ğŸ”„ ç•ªèŒ„é’Ÿå·²é‡ç½®');
            updateTimerDisplay();
        }
        
        // è®¡æ—¶å™¨å®Œæˆ
        function timerComplete() {
            isTimerRunning = false;
            clearInterval(timerInterval);
            
            // æ›´æ–°ç»Ÿè®¡
            timerStats.completedPomodoros++;
            timerStats.focusTime += Math.round(totalSeconds / 60);
            updateTimerStats();
            
            // ä¿å­˜ç»Ÿè®¡åˆ°localStorage
            const today = new Date().toDateString();
            const dailyStats = JSON.parse(localStorage.getItem('pomodoroStats_' + today) || '{}');
            Object.assign(dailyStats, timerStats);
            localStorage.setItem('pomodoroStats_' + today, JSON.stringify(dailyStats));
            
            // æ˜¾ç¤ºå®Œæˆé€šçŸ¥
            showNotification('ğŸ‰ ç•ªèŒ„é’Ÿå®Œæˆï¼è¯¥ä¼‘æ¯ä¸€ä¸‹äº†', 'success', 5000);
            
            // é‡ç½®è®¡æ—¶å™¨
            resetTimer();
            
            updateStatus('âœ… ç•ªèŒ„é’Ÿå®Œæˆï¼');
        }
        
        // è®¾ç½®é¢„è®¾æ—¶é—´
        function setPresetTime(minutes) {
            totalSeconds = minutes * 60;
            remainingSeconds = totalSeconds;
            
            // æ›´æ–°é¢„è®¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.timer-preset').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡ç½®è®¡æ—¶å™¨çŠ¶æ€
            resetTimer();
            updateTimerDisplay();
            
            updateStatus(`â° å·²è®¾ç½®${minutes}åˆ†é’Ÿ`);
        }
        
        // è®¾ç½®è‡ªå®šä¹‰æ—¶é—´
        function setCustomTime() {
            const customInput = document.getElementById('customMinutes');
            const minutes = parseInt(customInput.value);
            
            if (!minutes || minutes < 1 || minutes > 120) {
                showNotification('è¯·è¾“å…¥1-120ä¹‹é—´çš„æœ‰æ•ˆåˆ†é’Ÿæ•°', 'warning');
                return;
            }
            
            totalSeconds = minutes * 60;
            remainingSeconds = totalSeconds;
            
            // æ¸…é™¤é¢„è®¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.timer-preset').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // é‡ç½®è®¡æ—¶å™¨çŠ¶æ€
            resetTimer();
            updateTimerDisplay();
            
            updateStatus(`â° å·²è®¾ç½®è‡ªå®šä¹‰æ—¶é—´${minutes}åˆ†é’Ÿ`);
        }
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateTimerStats() {
            const completedElement = document.getElementById('completedPomodoros');
            const focusTimeElement = document.getElementById('focusTime');
            const breakTimeElement = document.getElementById('breakTime');
            
            if (completedElement) {
                completedElement.textContent = timerStats.completedPomodoros;
            }
            if (focusTimeElement) {
                focusTimeElement.textContent = timerStats.focusTime + 'åˆ†é’Ÿ';
            }
            if (breakTimeElement) {
                breakTimeElement.textContent = timerStats.breakTime + 'åˆ†é’Ÿ';
            }
        }
        
        // åŠ è½½æ¯æ—¥ç»Ÿè®¡
        function loadDailyStats() {
            const today = new Date().toDateString();
            const dailyStats = JSON.parse(localStorage.getItem('pomodoroStats_' + today) || '{}');
            
            timerStats.completedPomodoros = dailyStats.completedPomodoros || 0;
            timerStats.focusTime = dailyStats.focusTime || 0;
            timerStats.breakTime = dailyStats.breakTime || 0;
            
            updateTimerStats();
        }

        // åˆå§‹åŒ–Floating Dockäº¤äº’æ•ˆæœ
        function initFloatingDock() {
            const dockItems = document.querySelectorAll('.dock-item');
            
            // æ·»åŠ é¼ æ ‡è¿›å…¥æ—¶çš„åŠ¨ç”»æ•ˆæœ
            dockItems.forEach((item, index) => {
                item.addEventListener('mouseenter', () => {
                    // ä¸ºç›¸é‚»çš„å›¾æ ‡æ·»åŠ è½»å¾®çš„ç§»åŠ¨æ•ˆæœ
                    dockItems.forEach((otherItem, otherIndex) => {
                        if (otherIndex !== index) {
                            const distance = Math.abs(index - otherIndex);
                            const delay = distance * 0.05;
                            otherItem.style.transition = `all 0.3s ease ${delay}s`;
                            
                            // è·ç¦»è¶Šè¿‘ï¼Œç§»åŠ¨æ•ˆæœè¶Šæ˜æ˜¾
                            if (distance === 1) {
                                otherItem.style.transform = 'translateY(-3px)';
                            } else if (distance === 2) {
                                otherItem.style.transform = 'translateY(-1px)';
                            }
                        }
                    });
                });
                
                // é¼ æ ‡ç¦»å¼€æ—¶æ¢å¤åŸçŠ¶
                item.addEventListener('mouseleave', () => {
                    dockItems.forEach((otherItem) => {
                        otherItem.style.transition = 'all 0.3s ease';
                        otherItem.style.transform = '';
                    });
                });
                
                // ç‚¹å‡»æ—¶æ·»åŠ å¼¹è·³åŠ¨ç”»
                item.addEventListener('click', () => {
                    item.style.animation = 'dock-bounce 0.5s';
                    setTimeout(() => {
                        item.style.animation = '';
                    }, 500);
                });
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½è®¾ç½®
            loadSettings();
            
            // åˆå§‹åŒ–å¿«é€Ÿæ¨¡æ¿é€‰æ‹©å™¨
            setTimeout(() => {
                initQuickPromptSelect();
            }, 100);
            
            // åˆå§‹åŒ–æ–‡ä»¶æ ‘
             const knowledgeBasePath = getCurrentSettings().knowledgeBasePath;
             if (knowledgeBasePath) {
                 loadFileTree(knowledgeBasePath);
             }
             
             // ä¸ºAIè¾“å…¥æ¡†æ·»åŠ å¿«æ·é”®æ”¯æŒ
             const aiInput = document.getElementById('aiInput');
             if (aiInput) {
                 aiInput.addEventListener('keydown', function(event) {
                     if (event.ctrlKey && event.key === 'Enter') {
                         event.preventDefault();
                         sendToAI();
                     }
                 });
             }
             
             // åˆå§‹åŒ–ç•ªèŒ„é’Ÿ
             loadDailyStats();
             updateTimerDisplay();
             
             // åˆå§‹åŒ–Floating Dock
             setTimeout(() => {
                 initFloatingDock();
             }, 200);
        });
    </script>
</body>
</html>